<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Quran App</title>
    <style>
        :root {
            --bg-color-light: #e0e5ec;
            --text-color-light: #333;
            --primary-color-light: #6d5dfc;
            --highlight-color-light: rgba(109, 93, 252, 0.2);
            --neumorph-shadow-light-1: inset 5px 5px 10px #a3b1c6, inset -5px -5px 10px #ffffff;
            --neumorph-shadow-light-2: 5px 5px 10px #a3b1c6, -5px -5px 10px #ffffff;
            --glass-bg-light: rgba(255, 255, 255, 0.5);
            --glass-border-light: rgba(255, 255, 255, 0.3);

            --bg-color-dark: #1a1a1a;
            --text-color-dark: #e0e0e0;
            --primary-color-dark: #ffd700;
            --highlight-color-dark: rgba(255, 215, 0, 0.2);
            --neumorph-shadow-dark-1: inset 4px 4px 8px #0d0d0d, inset -4px -4px 8px #272727;
            --neumorph-shadow-dark-2: 4px 4px 8px #0d0d0d, -4px -4px 8px #272727;
            --glass-bg-dark: rgba(40, 40, 40, 0.6);
            --glass-border-dark: rgba(255, 215, 0, 0.2);

            --bg-color: var(--bg-color-light);
            --text-color: var(--text-color-light);
            --primary-color: var(--primary-color-light);
            --highlight-color: var(--highlight-color-light);
            --neumorph-shadow-1: var(--neumorph-shadow-light-1);
            --neumorph-shadow-2: var(--neumorph-shadow-light-2);
            --glass-bg: var(--glass-bg-light);
            --glass-border: var(--glass-border-light);

            --font-size-base: 16px;
            --font-size-arabic: 1.8rem;
            --font-size-urdu: 1.2rem;
            --line-height-arabic: 2.5;
            --line-height-urdu: 1.8;

            --bottom-nav-height: 60px;
            --header-height: 50px;
            --safe-area-top: env(safe-area-inset-top, 0px);
            --safe-area-bottom: env(safe-area-inset-bottom, 0px);
        }
        [data-theme="dark"] {
            --bg-color: var(--bg-color-dark);
            --text-color: var(--text-color-dark);
            --primary-color: var(--primary-color-dark);
            --highlight-color: var(--highlight-color-dark);
            --neumorph-shadow-1: var(--neumorph-shadow-dark-1);
            --neumorph-shadow-2: var(--neumorph-shadow-dark-2);
            --glass-bg: var(--glass-bg-dark);
            --glass-border: var(--glass-border-dark);
        }
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        html { font-size: var(--font-size-base); scroll-behavior: smooth; }
        body {
            font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif;
            background-color: var(--bg-color);
            color: var(--text-color);
            transition: background-color 0.3s ease, color 0.3s ease;
            overscroll-behavior-y: contain;
            height: 100vh;
            width: 100vw;
            overflow: hidden;
            display: flex;
            flex-direction: column;
        }
        .app-container { display: flex; flex-direction: column; height: 100%; width: 100%; }
        .main-content {
            flex-grow: 1;
            overflow-y: auto;
            padding: calc(var(--header-height) + 10px + var(--safe-area-top)) 15px calc(var(--bottom-nav-height) + 10px + var(--safe-area-bottom));
            position: relative;
        }
        .page { display: none; flex-direction: column; gap: 15px; }
        .page.active { display: flex; }
        .header {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            height: calc(var(--header-height) + var(--safe-area-top));
            padding-top: var(--safe-area-top);
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-bottom: 1px solid var(--glass-border);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 100;
            transition: background 0.3s ease, border-color 0.3s ease;
        }
        .header-title { font-size: 1.2rem; font-weight: bold; color: var(--primary-color); }
        .bottom-nav {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            height: calc(var(--bottom-nav-height) + var(--safe-area-bottom));
            padding-bottom: var(--safe-area-bottom);
            background: var(--glass-bg);
            backdrop-filter: blur(10px);
            -webkit-backdrop-filter: blur(10px);
            border-top: 1px solid var(--glass-border);
            display: flex;
            justify-content: space-around;
            align-items: center;
            z-index: 100;
            transition: background 0.3s ease, border-color 0.3s ease;
        }
        .nav-item {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            background: none;
            border: none;
            color: var(--text-color);
            cursor: pointer;
            padding: 5px;
            font-size: 0.7rem;
            opacity: 0.7;
            transition: opacity 0.2s ease, color 0.2s ease;
            flex-grow: 1;
            height: 100%;
        }
        .nav-item.active { opacity: 1; color: var(--primary-color); font-weight: bold; }
        .nav-item svg { width: 24px; height: 24px; margin-bottom: 2px; fill: currentColor; }
        .loader-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-color); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; }
        .loader { border: 4px solid rgba(0,0,0,0.1); border-left-color: var(--primary-color); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .loader-text { margin-top: 15px; color: var(--text-color); }
        .surah-list, .ayah-list, .bookmark-list { list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: 10px; }
        .list-item {
            background: var(--bg-color);
            padding: 15px;
            border-radius: 10px;
            box-shadow: var(--neumorph-shadow-2);
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .list-item:active { transform: scale(0.98); box-shadow: var(--neumorph-shadow-1); }
        .surah-info { display: flex; align-items: center; gap: 10px; }
        .surah-number {
            background-color: var(--primary-color);
            color: var(--bg-color);
            border-radius: 50%;
            width: 30px;
            height: 30px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.8rem;
            font-weight: bold;
        }
        [data-theme="dark"] .surah-number { color: #000; }
        .surah-name { font-weight: bold; }
        .surah-details { font-size: 0.8rem; opacity: 0.7; }
        .ayah-item {
            background: var(--bg-color);
            padding: 15px;
            border-radius: 10px;
            box-shadow: var(--neumorph-shadow-2);
            margin-bottom: 15px;
            transition: box-shadow 0.3s ease;
            position: relative;
        }
        .ayah-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; opacity: 0.8; font-size: 0.9rem; }
        .ayah-controls button { background: none; border: none; cursor: pointer; color: var(--text-color); padding: 5px; opacity: 0.7; }
        .ayah-controls button.active { color: var(--primary-color); opacity: 1; }
        .ayah-text-arabic { font-size: var(--font-size-arabic); line-height: var(--line-height-arabic); text-align: right; margin-bottom: 10px; direction: rtl; font-family: 'Amiri Quran', serif; }
        .ayah-text-urdu { font-size: var(--font-size-urdu); line-height: var(--line-height-urdu); text-align: right; direction: rtl; font-family: 'Noto Nastaliq Urdu', serif; }
        .ayah-item.read { border-left: 5px solid var(--primary-color); opacity: 0.8; }
        .ayah-item mark { background-color: var(--highlight-color); padding: 0.1em 0; border-radius: 3px; }
        .search-input-container { position: relative; margin-bottom: 15px; }
        .search-input {
            width: 100%;
            padding: 15px 20px;
            border-radius: 25px;
            border: none;
            background: var(--bg-color);
            box-shadow: var(--neumorph-shadow-1);
            font-size: 1rem;
            color: var(--text-color);
            outline: none;
            transition: box-shadow 0.3s ease;
        }
        .search-input:focus { box-shadow: var(--neumorph-shadow-2); }
        #search-suggestions {
             list-style: none;
             padding: 0;
             margin: 5px 0 0 0;
             position: absolute;
             width: 100%;
             max-height: 300px;
             overflow-y: auto;
             background: var(--glass-bg);
             backdrop-filter: blur(5px);
             -webkit-backdrop-filter: blur(5px);
             border: 1px solid var(--glass-border);
             border-radius: 10px;
             z-index: 50;
             box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }
        #search-suggestions li { padding: 10px 15px; cursor: pointer; border-bottom: 1px solid var(--glass-border); }
        #search-suggestions li:last-child { border-bottom: none; }
        #search-suggestions li:hover { background: var(--highlight-color); }
        #search-suggestions mark { background: none; color: var(--primary-color); font-weight: bold; }
        .settings-item { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid rgba(128, 128, 128, 0.2); }
        .settings-item:last-child { border-bottom: none; }
        .settings-item label { font-weight: bold; }
        .toggle-switch { position: relative; display: inline-block; width: 50px; height: 26px; }
        .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; border-radius: 26px; transition: .4s; box-shadow: var(--neumorph-shadow-1); }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; border-radius: 50%; transition: .4s; box-shadow: var(--neumorph-shadow-2); }
        input:checked + .slider { background-color: var(--primary-color); }
        input:checked + .slider:before { transform: translateX(24px); }
        .font-size-control, .language-toggle { display: flex; gap: 10px; align-items: center; }
        .font-size-control button, .language-toggle button {
             padding: 5px 10px;
             border: none;
             border-radius: 5px;
             background: var(--bg-color);
             box-shadow: var(--neumorph-shadow-2);
             cursor: pointer;
             transition: box-shadow 0.2s ease, background-color 0.2s ease;
             color: var(--text-color);
        }
        .font-size-control button:active, .language-toggle button:active { box-shadow: var(--neumorph-shadow-1); }
        .language-toggle button.active { background-color: var(--primary-color); color: var(--bg-color); }
        [data-theme="dark"] .language-toggle button.active { color: #000; }
        .progress-container { margin-top: 10px; }
        .progress-bar { width: 100%; height: 8px; background-color: rgba(128, 128, 128, 0.2); border-radius: 4px; overflow: hidden; }
        .progress-bar-inner { height: 100%; width: 0%; background-color: var(--primary-color); border-radius: 4px; transition: width 0.5s ease; }
        .progress-text { text-align: center; font-size: 0.8rem; margin-top: 5px; opacity: 0.8; }
        .reading-mode {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: var(--bg-color);
            z-index: 1000;
            display: none;
            flex-direction: column;
            justify-content: center;
            align-items: center;
            padding: 30px;
            touch-action: pan-y; /* Allow vertical scroll but capture horizontal */
            overflow: hidden; /* Prevent body scroll */
        }
        .reading-content {
            width: 100%;
            max-width: 800px;
            text-align: center;
            overflow-y: auto;
            max-height: 90%;
        }
        .reading-ayah-arabic { font-size: calc(var(--font-size-arabic) * 1.2); line-height: calc(var(--line-height-arabic) * 1.1); text-align: center; margin-bottom: 20px; direction: rtl; font-family: 'Amiri Quran', serif; }
        .reading-ayah-urdu { font-size: calc(var(--font-size-urdu) * 1.1); line-height: calc(var(--line-height-urdu) * 1.1); text-align: center; direction: rtl; font-family: 'Noto Nastaliq Urdu', serif; }
        .reading-mode-close { position: absolute; top: 20px; right: 20px; background: none; border: none; color: var(--text-color); font-size: 2rem; cursor: pointer; opacity: 0.5; z-index: 1001; }
        .reading-nav-overlay { position: absolute; top: 0; bottom: 0; width: 30%; cursor: pointer; z-index: 1; /* Higher than content */ }
        .reading-nav-prev { left: 0; }
        .reading-nav-next { right: 0; }
        .swipe-indicator { position: absolute; bottom: 10px; left: 50%; transform: translateX(-50%); font-size: 0.8rem; opacity: 0.5; }
        [data-display="arabic"] .ayah-text-urdu, [data-display="arabic"] .reading-ayah-urdu { display: none; }
        [data-display="urdu"] .ayah-text-arabic, [data-display="urdu"] .reading-ayah-arabic { display: none; }
        [data-display="both"] .ayah-text-arabic, [data-display="both"] .ayah-text-urdu,
        [data-display="both"] .reading-ayah-arabic, [data-display="both"] .reading-ayah-urdu { display: block; }
        @media (max-width: 600px) {
             /* Add mobile specific styles if needed */
        }
        @font-face { font-family: 'Amiri Quran'; src: url('https://fonts.gstatic.com/s/amiriquran/v6/XZuz_gLSbMAb2JNdAJcQ7fD8.woff2') format('woff2'); unicode-range: U+0600-06FF, U+0750-077F, U+08A0-08FF, U+FB50-FDFF, U+FE70-FEFF; font-display: swap; }
        @font-face { font-family: 'Noto Nastaliq Urdu'; src: url('https://fonts.gstatic.com/s/notonastaliqurdu/v14/XRXJrd4E-HPER4aTA_RTl2Hr7CH6wL-N.woff2') format('woff2'); unicode-range: U+0600-06FF, U+0750-077F, U+FB50-FDFF, U+FE70-FEFF; font-display: swap; }
    </style>
</head>
<body data-theme="light" data-font-size="medium" data-display="both">

    <div class="app-container">
        <header class="header">
            <span class="header-title">Quran App</span>
        </header>

        <main class="main-content">
            <div id="page-home" class="page active">
                <h2>Welcome</h2>
                <p>Start your Quran journey.</p>
                <div class="progress-container">
                    <h3>Reading Progress</h3>
                    <div class="progress-bar">
                        <div class="progress-bar-inner" id="progress-bar-inner"></div>
                    </div>
                    <p class="progress-text" id="progress-text">0%</p>
                </div>
                <div>
                    <h3>Last Read</h3>
                    <p id="last-read-info">Not started yet.</p>
                    <button id="resume-reading-btn" style="display: none; padding: 10px 15px; margin-top: 10px; background: var(--primary-color); color: var(--bg-color); border: none; border-radius: 5px; cursor: pointer; box-shadow: var(--neumorph-shadow-2);">Resume Reading</button>
                    [data-theme="dark"] #resume-reading-btn { color: #000; }
                </div>
            </div>

            <div id="page-surahs" class="page">
                <ul class="surah-list" id="surah-list"></ul>
            </div>

            <div id="page-search" class="page">
                <div class="search-input-container">
                    <input type="text" id="search-input" class="search-input" placeholder="Search Arabic or Urdu...">
                    <ul id="search-suggestions"></ul>
                </div>
                <div id="search-results" class="ayah-list"></div>
            </div>

            <div id="page-bookmarks" class="page">
                <h2>Bookmarks</h2>
                <ul class="bookmark-list" id="bookmark-list"></ul>
                 <p id="no-bookmarks-msg" style="display: none; text-align: center; opacity: 0.7;">No bookmarks added yet.</p>
            </div>

            <div id="page-settings" class="page">
                <h2>Settings</h2>
                <div class="settings-item">
                    <label for="dark-mode-toggle">Dark Mode</label>
                    <label class="toggle-switch">
                        <input type="checkbox" id="dark-mode-toggle">
                        <span class="slider"></span>
                    </label>
                </div>
                <div class="settings-item">
                    <label>Font Size</label>
                    <div class="font-size-control">
                        <button data-size="small">S</button>
                        <button data-size="medium">M</button>
                        <button data-size="large">L</button>
                    </div>
                </div>
                 <div class="settings-item">
                    <label>Display</label>
                    <div class="language-toggle">
                        <button data-display="arabic">Arabic</button>
                        <button data-display="urdu">Urdu</button>
                        <button data-display="both">Both</button>
                    </div>
                </div>
                 <div class="settings-item">
                     <button id="clear-data-btn" style="color: #ff4d4d; background: none; border: 1px solid #ff4d4d; padding: 8px 12px; border-radius: 5px; cursor: pointer;">Clear All Data & Reload</button>
                 </div>
            </div>

            <div id="page-ayahs" class="page">
                <h2 id="ayah-view-surah-title"></h2>
                <div id="ayah-list" class="ayah-list"></div>
            </div>
        </main>

        <nav class="bottom-nav">
            <button class="nav-item active" data-page="home">
                <svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg>
                Home
            </button>
            <button class="nav-item" data-page="surahs">
                 <svg viewBox="0 0 24 24"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg>
                Surahs
            </button>
            <button class="nav-item" data-page="search">
                <svg viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27a6.5 6.5 0 0 0 1.48-5.34c-.47-2.78-2.79-5-5.59-5.34a6.505 6.505 0 0 0-7.27 7.27c.34 2.8 2.56 5.12 5.34 5.59a6.5 6.5 0 0 0 5.34-1.48l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg>
                Search
            </button>
            <button class="nav-item" data-page="bookmarks">
                 <svg viewBox="0 0 24 24"><path d="M17 3H7c-1.1 0-2 .9-2 2v16l7-3 7 3V5c0-1.1-.9-2-2-2z"/></svg>
                Bookmarks
            </button>
            <button class="nav-item" data-page="settings">
                 <svg viewBox="0 0 24 24"><path d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61.25-1.17.59-1.69.98l-2.49-1c-.23-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19.15-.24.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1c.52.4 1.08.73 1.69.98l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49-.42l.38-2.65c.61-.25 1.17-.59 1.69-.98l2.49 1c.23.09.49 0 .61-.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.65zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z"/></svg>
                Settings
            </button>
        </nav>
    </div>

     <div class="reading-mode" id="reading-mode">
        <button class="reading-mode-close" id="reading-mode-close">&times;</button>
        <div class="reading-nav-overlay reading-nav-prev" id="reading-nav-prev"></div>
        <div class="reading-nav-overlay reading-nav-next" id="reading-nav-next"></div>
        <div class="reading-content" id="reading-content">
            <p class="reading-ayah-arabic" dir="rtl"></p>
            <p class="reading-ayah-urdu" dir="rtl"></p>
        </div>
        <div class="swipe-indicator">&lt; Swipe &gt;</div>
    </div>


    <div class="loader-container" id="loader">
        <div class="loader"></div>
        <p class="loader-text" id="loader-text">Initializing...</p>
    </div>

<script type="text/plain" id="quran-data">
بِسْمِ اللّٰهِ الرَّحْمٰنِ الرَّحِيْمِ ترجمہ: اللہ کے نام سے شروع جو نہایت مہربان ہمیشہ رحم فرمانے والا ہے<br/>س 1 آ 1
اَلْحَمْدُ لِلّٰهِ رَبِّ الْعٰلَمِيْنَۙ ترجمہ: سب تعریفیں اللہ ہی کے لئے ہیں جو تمام جہانوں کی پرورش فرمانے والا ہے<br/>س 1 آ 2
الرَّحْمٰنِ الرَّحِيْمِۙ ترجمہ: نہایت مہربان بہت رحم فرمانے والا ہے<br/>س 1 آ 3
مٰلِكِ يَوْمِ الدِّيْنِؕ ترجمہ: روزِ جزا کا مالک ہے<br/>س 1 آ 4
اِيَّاكَ نَعْبُدُ وَ اِيَّاكَ نَسْتَعِيْنُؕ ترجمہ: (اے اللہ!) ہم تیری ہی عبادت کرتے ہیں اور ہم تجھ ہی سے مدد چاہتے ہیں<br/>س 1 آ 5
اِهْدِنَا الصِّرَاطَ الْمُسْتَقِيْمَۙ ترجمہ: ہمیں سیدھا راستہ دکھا<br/>س 1 آ 6
صِرَاطَ الَّذِيْنَ اَنْعَمْتَ عَلَيْهِمْ ۙ۬ غَيْرِ الْمَغْضُوْبِ عَلَيْهِمْ وَ لَا الضَّآلِّيْنَ۠ ترجمہ: ان لوگوں کا راستہ جن پر تو نے انعام فرمایا۔ ان لوگوں کا نہیں جن پر غضب کیا گیا ہے اور نہ (ہی) گمراہوں کا<br/>س 1 آ 7
الٓمّٓۚ ترجمہ: الم<br/>س 2 آ 1
ذٰلِكَ الْكِتٰبُ لَا رَيْبَ ۚۖۛ فِيْهِ ۚۛ هُدًى لِّلْمُتَّقِيْنَۙ ترجمہ: یہ وہ عظیم کتاب ہے جس میں کسی شک کی گنجائش نہیں، (یہ) پرہیزگاروں کے لئے ہدایت ہے<br/>س 2 آ 2
الَّذِيْنَ يُؤْمِنُوْنَ بِالْغَيْبِ وَ يُقِيْمُوْنَ الصَّلٰوةَ وَ مِمَّا رَزَقْنٰهُمْ يُنْفِقُوْنَۙ ترجمہ: جو غیب پر ایمان لاتے اور نماز قائم کرتے ہیں اور جو کچھ ہم نے انہیں عطا کیا ہے اس میں سے خرچ کرتے ہیں<br/>س 2 آ 3
وَ الَّذِيْنَ يُؤْمِنُوْنَ بِمَاۤ اُنْزِلَ اِلَيْكَ وَ مَاۤ اُنْزِلَ مِنْ قَبْلِكَۚ وَ بِالْاٰخِرَةِ هُمْ يُوْقِنُوْنَؕ ترجمہ: اور جو آپ کی طرف نازل کیا گیا اور جو آپ سے پہلے نازل کیا گیا (سب) پر ایمان لاتے ہیں، اور وہ آخرت پر بھی (کامل) یقین رکھتے ہیں<br/>س 2 آ 4
اُولٰٓىِٕكَ عَلٰى هُدًى مِّنْ رَّبِّهِمْۗ وَ اُولٰٓىِٕكَ هُمُ الْمُفْلِحُوْنَ ترجمہ: وہی لوگ اپنے ربّ کی طرف سے ہدایت پر ہیں اور وہی لوگ فلاح پانے والے ہیں<br/>س 2 آ 5
اِنَّ الَّذِيْنَ كَفَرُوْا سَوَآءٌ عَلَيْهِمْ ءَاَنْذَرْتَهُمْ اَمْ لَمْ تُنْذِرْهُمْ لَا يُؤْمِنُوْنَ ترجمہ: بیشک جن لوگوں نے کفر کیا ان کے لئے برابر ہے خواہ آپ انہیں ڈرائیں یا نہ ڈرائیں، وہ ایمان نہیں لائیں گے<br/>س 2 آ 6
خَتَمَ اللّٰهُ عَلٰى قُلُوْبِهِمْ وَ عَلٰى سَمْعِهِمْؕ وَ عَلٰۤى اَبْصَارِهِمْ غِشَاوَةٌ وَّ لَهُمْ عَذَابٌ عَظِيْمٌۧ ترجمہ: اللہ نے ان کے دلوں اور ان کے کانوں پر مہر لگا دی ہے اور ان کی آنکھوں پر پردہ (پڑا ہوا) ہے اور ان کے لئے بڑا عذاب ہے<br/>س 2 آ 7
وَ مِنَ النَّاسِ مَنْ يَّقُوْلُ اٰمَنَّا بِاللّٰهِ وَ بِالْيَوْمِ الْاٰخِرِ وَ مَا هُمْ بِمُؤْمِنِيْنَۘ ترجمہ: اور لوگوں میں سے بعض وہ (بھی) ہیں جو کہتے ہیں ہم اللہ پر اور یومِ آخرت پر ایمان لائے حالانکہ وہ (ہرگز) مومن نہیں ہیں<br/>س 2 آ 8
يُخٰدِعُوْنَ اللّٰهَ وَ الَّذِيْنَ اٰمَنُوْاۚ وَ مَا يَخْدَعُوْنَ اِلَّاۤ اَنْفُسَهُمْ وَ مَا يَشْعُرُوْنَؕ ترجمہ: وہ (اپنے گمان میں) اللہ کو اور ان لوگوں کو جو ایمان لاچکے ہیں دھوکہ دینا چاہتے ہیں مگر (فی الحقیقت) وہ اپنے آپ کو ہی دھوکہ دے رہے ہیں اور انہیں (اس کا) شعور تک نہیں<br/>س 2 آ 9
فِيْ قُلُوْبِهِمْ مَّرَضٌۙ فَزَادَهُمُ اللّٰهُ مَرَضًاۚ وَّ لَهُمْ عَذَابٌ اَلِيْمٌۢۙ بِمَا كَانُوْا يَكْذِبُوْنَ ترجمہ: ان کے دلوں میں بیماری ہے، پس اللہ نے ان کی بیماری کو اور بڑھا دیا اور ان کے لئے دردناک عذاب ہے اس وجہ سے کہ وہ جھوٹ بولا کرتے تھے<br/>س 2 آ 10
وَ اِذَا قِيْلَ لَهُمْ لَا تُفْسِدُوْا فِى الْاَرْضِۙ قَالُوْۤا اِنَّمَا نَحْنُ مُصْلِحُوْنَ ترجمہ: اور جب ان سے کہا جاتا ہے کہ زمین میں فساد بپا نہ کرو تو کہتے ہیں: ہم ہی تو اصلاح کرنے والے ہیں<br/>س 2 آ 11
اَلَاۤ اِنَّهُمْ هُمُ الْمُفْسِدُوْنَ وَ لٰكِنْ لَّا يَشْعُرُوْنَ ترجمہ: آگاہ ہو جاؤ! یہی لوگ (حقیقت میں) فساد کرنے والے ہیں مگر انہیں (اس کا) شعور نہیں<br/>س 2 آ 12
وَ اِذَا قِيْلَ لَهُمْ اٰمِنُوْا كَمَاۤ اٰمَنَ النَّاسُ قَالُوْۤا اَنُؤْمِنُ كَمَاۤ اٰمَنَ السُّفَهَآءُؕ اَلَاۤ اِنَّهُمْ هُمُ السُّفَهَآءُ وَ لٰكِنْ لَّا يَعْلَمُوْنَ ترجمہ: اور جب ان سے کہا جاتا ہے کہ (تم بھی) اسی طرح ایمان لاؤ جیسے (دوسرے) لوگ ایمان لائے ہیں تو کہتے ہیں: کیا ہم (بھی) اسی طرح ایمان لے آئیں جیسے بیوقوف لوگ ایمان لائے ہیں، آگاہ ہو جاؤ! بیوقوف تو (حقیقت میں) یہی لوگ ہیں مگر (اسے) جانتے نہیں ہیں<br/>س 2 آ 13
وَ اِذَا لَقُوا الَّذِيْنَ اٰمَنُوْا قَالُوْۤا اٰمَنَّاۚۖ وَّ اِذَا خَلَوْا اِلٰى شَيٰطِيْنِهِمْۙ قَالُوْۤا اِنَّا مَعَكُمْۙ اِنَّمَا نَحْنُ مُسْتَهْزِءُوْنَ ترجمہ: اور جب وہ اہلِ ایمان سے ملتے ہیں تو کہتے ہیں: ہم (بھی) ایمان لے آئے ہیں، اور جب اپنے شیطانوں کے پاس تنہائی میں جاتے ہیں تو کہتے ہیں: ہم یقیناً تمہارے ساتھ ہیں، ہم (مسلمانوں کا تو) محض مذاق اڑاتے ہیں<br/>س 2 آ 14
اَللّٰهُ يَسْتَهْزِئُ بِهِمْ وَ يَمُدُّهُمْ فِيْ طُغْيَانِهِمْ يَعْمَهُوْنَ ترجمہ: اللہ ان (منافقوں) سے (ان کی حالتِ نفاق پر بطورِ سزا) استہزاء فرماتا ہے اور انہیں ان کی سرکشی میں ڈھیل دیتا ہے، سو وہ بھٹکتے پھر رہے ہیں<br/>س 2 آ 15
اُولٰٓىِٕكَ الَّذِيْنَ اشْتَرَوُا الضَّلٰلَةَ بِالْهُدٰى فَمَا رَبِحَتْ تِّجَارَتُهُمْ وَ مَا كَانُوْا مُهْتَدِيْنَ ترجمہ: یہی وہ لوگ ہیں جنہوں نے ہدایت کے بدلے گمراہی خریدی مگر ان کی تجارت (سود مند) نہ ہوئی اور وہ (کبھی) راہِ ہدایت پر آنے والے نہ تھے<br/>س 2 آ 16
مَثَلُهُمْ كَمَثَلِ الَّذِى اسْتَوْقَدَ نَارًاۚ فَلَمَّاۤ اَضَآءَتْ مَا حَوْلَهٗ ذَهَبَ اللّٰهُ بِنُوْرِهِمْ وَ تَرَكَهُمْ فِيْ ظُلُمٰتٍ لَّا يُبْصِرُوْنَ ترجمہ: ان کی مثال ایسے شخص کی سی ہے جس نے (تاریکی میں) آگ جلائی اور جب اس نے گرد و پیش کو روشن کر دیا تو اللہ نے ان کا نور سلب کر لیا اور انہیں تاریکیوں میں چھوڑ دیا کہ وہ (کچھ) نہیں دیکھتے<br/>س 2 آ 17
صُمٌّۢ بُكْمٌ عُمْيٌ فَهُمْ لَا يَرْجِعُوْنَۙ ترجمہ: یہ بہرے، گونگے، اندھے ہیں پس وہ (راہِ راست کی طرف) نہیں لوٹیں گے<br/>س 2 آ 18
اَوْ كَصَيِّبٍ مِّنَ السَّمَآءِ فِيْهِ ظُلُمٰتٌ وَّ رَعْدٌ وَّ بَرْقٌۚ يَجْعَلُوْنَ اَصَابِعَهُمْ فِيْۤ اٰذَانِهِمْ مِّنَ الصَّوَاعِقِ حَذَرَ الْمَوْتِؕ وَ اللّٰهُ مُحِيْطٌۢ بِالْكٰفِرِيْنَ ترجمہ: یا (ان کی مثال) کڑک اور چمک کے ساتھ آسمان سے برسنے والی بارش کی سی ہے جس میں تاریکیاں ہوں، وہ موت کے ڈر سے کڑک کے باعث اپنی انگلیاں اپنے کانوں میں ٹھونس لیتے ہیں، اور اللہ کافروں کو گھیرے ہوئے ہے<br/>س 2 آ 19
يَكَادُ الْبَرْقُ يَخْطَفُ اَبْصَارَهُمْؕ كُلَّمَاۤ اَضَآءَ لَهُمْ مَّشَوْا فِيْهِ وَ اِذَاۤ اَظْلَمَ عَلَيْهِمْ قَامُوْاؕ وَ لَوْ شَآءَ اللّٰهُ لَذَهَبَ بِسَمْعِهِمْ وَ اَبْصَارِهِمْؕ اِنَّ اللّٰهَ عَلٰى كُلِّ شَيْءٍ قَدِيْرٌ۠ ترجمہ: قریب ہے کہ بجلی (کی چمک) ان کی آنکھوں (کی بینائی) کو اچک لے جائے، جب بھی ان پر بجلی چمکتی ہے تو وہ اس (روشنی) میں چل پڑتے ہیں اور جب ان پر اندھیرا چھا جاتا ہے تو وہ کھڑے ہو جاتے ہیں، اور اگر اللہ چاہتا تو ان کے کانوں (کی شنوائی) اور ان کی آنکھوں (کی بینائی) کو ضرور سلب کر لیتا، بیشک اللہ ہر چیز پر کامل قدرت رکھتا ہے<br/>س 2 آ 20
</script>

<script>
    const DB_NAME = 'quranDB';
    const DB_VERSION = 1;
    const STORE_NAME = 'ayahs';
    const SETTINGS_STORE_NAME = 'settings';
    const SURAHS_COUNT = 114;
    const TOTAL_AYAHS = 6236; // Approximate, actual count depends on data source. Will recalculate.

    const surahNames = ["Al-Fatiha", "Al-Baqarah", "Aal-e-Imran", "An-Nisa", "Al-Ma'idah", "Al-An'am", "Al-A'raf", "Al-Anfal", "At-Tawbah", "Yunus", "Hud", "Yusuf", "Ar-Ra'd", "Ibrahim", "Al-Hijr", "An-Nahl", "Al-Isra", "Al-Kahf", "Maryam", "Taha", "Al-Anbiya", "Al-Hajj", "Al-Mu'minun", "An-Nur", "Al-Furqan", "Ash-Shu'ara", "An-Naml", "Al-Qasas", "Al-Ankabut", "Ar-Rum", "Luqman", "As-Sajdah", "Al-Ahzab", "Saba", "Fatir", "Ya-Sin", "As-Saffat", "Sad", "Az-Zumar", "Ghafir", "Fussilat", "Ash-Shura", "Az-Zukhruf", "Ad-Dukhan", "Al-Jathiyah", "Al-Ahqaf", "Muhammad", "Al-Fath", "Al-Hujurat", "Qaf", "Adh-Dhariyat", "At-Tur", "An-Najm", "Al-Qamar", "Ar-Rahman", "Al-Waqi'ah", "Al-Hadid", "Al-Mujadila", "Al-Hashr", "Al-Mumtahanah", "As-Saff", "Al-Jumu'ah", "Al-Munafiqun", "At-Taghabun", "At-Talaq", "At-Tahrim", "Al-Mulk", "Al-Qalam", "Al-Haqqah", "Al-Ma'arij", "Nuh", "Al-Jinn", "Al-Muzzammil", "Al-Muddaththir", "Al-Qiyamah", "Al-Insan", "Al-Mursalat", "An-Naba", "An-Nazi'at", "'Abasa", "At-Takwir", "Al-Infitar", "Al-Mutaffifin", "Al-Inshiqaq", "Al-Buruj", "At-Tariq", "Al-A'la", "Al-Ghashiyah", "Al-Fajr", "Al-Balad", "Ash-Shams", "Al-Layl", "Ad-Duha", "Ash-Sharh", "At-Tin", "Al-'Alaq", "Al-Qadr", "Al-Bayyinah", "Az-Zalzalah", "Al-'Adiyat", "Al-Qari'ah", "At-Takathur", "Al-'Asr", "Al-Humazah", "Al-Fil", "Quraysh", "Al-Ma'un", "Al-Kawthar", "Al-Kafirun", "An-Nasr", "Al-Masad", "Al-Ikhlas", "Al-Falaq", "An-Nas"];

    let db;
    let currentSurah = null;
    let currentAyah = null;
    let readingModeActive = false;
    let readingModeCurrentId = null;
    let touchStartX = 0;
    let touchEndX = 0;
    let searchDebounceTimer;
    let currentSettings = {
        theme: 'light',
        fontSize: 'medium',
        display: 'both'
    };
    let lastRead = { surah: null, ayah: null, id: null };
    let actualTotalAyahs = 0; // Will be set after population or count

    const loader = document.getElementById('loader');
    const loaderText = document.getElementById('loader-text');
    const pages = document.querySelectorAll('.page');
    const navItems = document.querySelectorAll('.nav-item');
    const headerTitle = document.querySelector('.header-title');
    const surahListEl = document.getElementById('surah-list');
    const ayahListEl = document.getElementById('ayah-list');
    const ayahViewSurahTitle = document.getElementById('ayah-view-surah-title');
    const searchInput = document.getElementById('search-input');
    const searchSuggestionsEl = document.getElementById('search-suggestions');
    const searchResultsEl = document.getElementById('search-results');
    const bookmarkListEl = document.getElementById('bookmark-list');
    const noBookmarksMsg = document.getElementById('no-bookmarks-msg');
    const darkModeToggle = document.getElementById('dark-mode-toggle');
    const fontSizeControls = document.querySelector('.font-size-control');
    const languageToggleControls = document.querySelector('.language-toggle');
    const progressBarInner = document.getElementById('progress-bar-inner');
    const progressText = document.getElementById('progress-text');
    const lastReadInfo = document.getElementById('last-read-info');
    const resumeReadingBtn = document.getElementById('resume-reading-btn');
    const readingModeEl = document.getElementById('reading-mode');
    const readingContentEl = document.getElementById('reading-content');
    const readingArabicEl = readingContentEl.querySelector('.reading-ayah-arabic');
    const readingUrduEl = readingContentEl.querySelector('.reading-ayah-urdu');
    const readingModeCloseBtn = document.getElementById('reading-mode-close');
    const readingNavPrev = document.getElementById('reading-nav-prev');
    const readingNavNext = document.getElementById('reading-nav-next');
    const clearDataBtn = document.getElementById('clear-data-btn');
    const body = document.body;

    function showLoader(text = 'Loading...') {
        loaderText.textContent = text;
        loader.style.display = 'flex';
    }

    function hideLoader() {
        loader.style.display = 'none';
    }

    function initDB() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(DB_NAME, DB_VERSION);

            request.onupgradeneeded = (event) => {
                db = event.target.result;
                 let store;
                 if (!db.objectStoreNames.contains(STORE_NAME)) {
                     store = db.createObjectStore(STORE_NAME, { keyPath: 'id', autoIncrement: true });
                     store.createIndex('surah_ayah', ['surah', 'ayah'], { unique: true });
                     store.createIndex('surah', 'surah', { unique: false });
                     store.createIndex('arabic', 'arabic', { unique: false });
                     store.createIndex('urdu', 'urdu', { unique: false });
                     store.createIndex('bookmarked', 'bookmarked', { unique: false });
                     store.createIndex('read', 'read', { unique: false });
                 } else {
                     store = event.target.transaction.objectStore(STORE_NAME);
                     // Add checks for existing indexes if needed, although typically handled by version increment
                 }

                 if (!db.objectStoreNames.contains(SETTINGS_STORE_NAME)) {
                    db.createObjectStore(SETTINGS_STORE_NAME, { keyPath: 'key' });
                }
            };

            request.onsuccess = (event) => {
                db = event.target.result;
                console.log('Database opened successfully.');
                resolve(db);
            };

            request.onerror = (event) => {
                console.error('Database error:', event.target.errorCode);
                reject(event.target.error);
            };
        });
    }

     function getSetting(key) {
        return new Promise((resolve, reject) => {
            if (!db) return reject("DB not initialized");
            // Check if the store exists before creating transaction
            if (!db.objectStoreNames.contains(SETTINGS_STORE_NAME)) {
                return resolve(undefined); // Store doesn't exist, return undefined setting
            }
            try {
                 const transaction = db.transaction(SETTINGS_STORE_NAME, 'readonly');
                 const store = transaction.objectStore(SETTINGS_STORE_NAME);
                 const request = store.get(key);
                 request.onsuccess = () => resolve(request.result ? request.result.value : undefined);
                 request.onerror = (event) => reject(event.target.error);
            } catch (e) {
                 // Handle cases where transaction creation might fail immediately (e.g., DB closed)
                 reject(`Error creating settings transaction: ${e}`);
            }
        });
    }

    function setSetting(key, value) {
        return new Promise((resolve, reject) => {
            if (!db) return reject("DB not initialized");
             // Ensure the store exists from onupgradeneeded or handle appropriately
            if (!db.objectStoreNames.contains(SETTINGS_STORE_NAME)) {
                // This shouldn't happen if initDB ran correctly, but handle defensively
                console.error("Settings store not found. Cannot save setting.");
                return reject("Settings store not found.");
            }
            try {
                const transaction = db.transaction(SETTINGS_STORE_NAME, 'readwrite');
                const store = transaction.objectStore(SETTINGS_STORE_NAME);
                const request = store.put({ key, value });
                request.onsuccess = () => resolve();
                request.onerror = (event) => reject(event.target.error);
             } catch (e) {
                 reject(`Error creating settings transaction: ${e}`);
             }
        });
    }


    function checkDBPopulated() {
        return new Promise((resolve, reject) => {
            if (!db) return reject("DB not initialized");
             // Check if the store exists first
            if (!db.objectStoreNames.contains(STORE_NAME)) {
                return resolve(false); // Not populated if store doesn't exist
            }
            try {
                const transaction = db.transaction(STORE_NAME, 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const countRequest = store.count();

                countRequest.onsuccess = () => {
                     actualTotalAyahs = countRequest.result; // Update actual total count
                     console.log(`Database contains ${actualTotalAyahs} records.`);
                     resolve(actualTotalAyahs > 0);
                };
                countRequest.onerror = (event) => {
                     console.error('Error counting records:', event.target.error);
                     reject(event.target.error);
                 };
             } catch (e) {
                 reject(`Error creating count transaction: ${e}`);
             }
        });
    }

    function parseAndPopulateDB() {
        return new Promise(async (resolve, reject) => {
            showLoader('Parsing data (first time)...');
            const dataElement = document.getElementById('quran-data');
            if (!dataElement || !dataElement.textContent) {
                hideLoader();
                alert("Error: Quran data not found in the HTML.");
                return reject("Quran data missing.");
            }
            const lines = dataElement.textContent.trim().split('\n');
            const regex = /(.+?)\s+ترجمہ:\s+(.+?)<br\/>س\s+(\d+)\s+آ\s+(\d+)/;
            let count = 0;
            let expectedTotal = 0; // Count expected items from parsing

            // Pre-count expected items to provide better progress indication
            lines.forEach(line => {
                 if (line.trim() && line.match(regex)) {
                     expectedTotal++;
                 }
             });
            showLoader(`Populating DB: 0/${expectedTotal}...`);

            const transaction = db.transaction(STORE_NAME, 'readwrite');
            const store = transaction.objectStore(STORE_NAME);
            let errorsEncountered = 0;

            transaction.oncomplete = () => {
                console.log(`Database population transaction completed. Added: ${count}, Errors: ${errorsEncountered}`);
                actualTotalAyahs = count; // Update total based on successful adds
                setSetting('db_populated', true);
                updateProgress(); // Update progress based on new total
                resolve();
            };
            transaction.onerror = (event) => {
                console.error('Transaction error during population:', event.target.error);
                hideLoader();
                reject(`Transaction error: ${event.target.error.message || event.target.error}`);
            };
             transaction.onabort = (event) => {
                 console.error('Transaction aborted during population:', event.target.error);
                 hideLoader();
                 // Provide more context if possible
                 const error = event.target.error;
                 reject(`Transaction aborted: ${error ? error.name + ' - ' + error.message : 'Unknown reason'}`);
             };


            for (let i = 0; i < lines.length; i++) {
                const line = lines[i].trim();
                if (!line) continue; // Skip empty lines

                const match = line.match(regex);
                if (match) {
                    const [, arabic, urdu, surah, ayah] = match;
                    const ayahData = {
                        surah: parseInt(surah),
                        ayah: parseInt(ayah),
                        arabic: arabic.trim(),
                        urdu: urdu.trim(),
                        bookmarked: 0,
                        read: 0
                    };

                    const request = store.add(ayahData);

                    request.onsuccess = () => {
                        count++;
                        // Update loader periodically without blocking UI thread excessively
                        if (count % 100 === 0 || count === expectedTotal) {
                           setTimeout(() => showLoader(`Populating DB: ${count}/${expectedTotal}...`), 0);
                        }
                    };
                    request.onerror = (event) => {
                         errorsEncountered++;
                         // Log non-constraint errors (like duplicates) but continue
                        if (event.target.error.name !== 'ConstraintError') {
                            console.error('Error adding ayah:', event.target.error.message, `Data: S${surah} A${ayah}`);
                         }
                         // IMPORTANT: Prevent the error from aborting the transaction
                         event.preventDefault();
                    };
                } else {
                    console.warn('Could not parse line:', line);
                }
            }
            // Transaction completes automatically when loop finishes & all requests settle
        });
    }


    function navigateToPage(pageId) {
        pages.forEach(page => page.classList.remove('active'));
        document.getElementById(`page-${pageId}`).classList.add('active');
        navItems.forEach(item => item.classList.remove('active'));
        const activeNavItem = document.querySelector(`.nav-item[data-page="${pageId}"]`);
        if(activeNavItem) activeNavItem.classList.add('active');

        // Update header title based on page
        switch (pageId) {
            case 'home': headerTitle.textContent = 'Quran App'; break;
            case 'surahs': headerTitle.textContent = 'Surahs'; break;
            case 'search': headerTitle.textContent = 'Search'; break;
            case 'bookmarks': headerTitle.textContent = 'Bookmarks'; break;
            case 'settings': headerTitle.textContent = 'Settings'; break;
            case 'ayahs': /* Title set dynamically */ break;
            default: headerTitle.textContent = 'Quran App';
        }

        // Special actions for certain pages
        if (pageId === 'surahs') loadSurahList();
        if (pageId === 'bookmarks') loadBookmarks();
        if (pageId === 'home') { updateProgress(); loadLastReadInfo();}
        if (pageId === 'search') { searchInput.value = ''; searchResultsEl.innerHTML = ''; searchSuggestionsEl.innerHTML = ''; searchSuggestionsEl.style.display = 'none'; }

        // Ensure main content scrolls to top when switching pages (except when going to Ayah view?)
        if (pageId !== 'ayahs') {
             const mainContent = document.querySelector('.main-content');
             if (mainContent) mainContent.scrollTop = 0;
         }
    }

    function loadSurahList() {
        surahListEl.innerHTML = ''; // Clear previous list
        const fragment = document.createDocumentFragment();
        for (let i = 1; i <= SURAHS_COUNT; i++) {
            const li = document.createElement('li');
            li.className = 'list-item surah-item';
            li.dataset.surah = i;
            li.innerHTML = `
                <div class="surah-info">
                    <span class="surah-number">${i}</span>
                    <span class="surah-name">${surahNames[i - 1] || `Surah ${i}`}</span>
                </div>
                <span class="surah-details">➔</span>
            `;
            li.addEventListener('click', () => {
                loadAyahView(i);
            });
            fragment.appendChild(li);
        }
        surahListEl.appendChild(fragment);
    }

    function loadAyahView(surahNumber) {
        currentSurah = surahNumber;
        headerTitle.textContent = `Surah ${surahNames[surahNumber - 1] || surahNumber} (${surahNumber})`;
        ayahViewSurahTitle.textContent = `Surah ${surahNames[surahNumber - 1] || surahNumber} (${surahNumber})`;
        navigateToPage('ayahs');
        showLoader(`Loading Surah ${surahNumber}...`);
        ayahListEl.innerHTML = ''; // Clear previous ayahs

        if (!db) {
             hideLoader();
             ayahListEl.innerHTML = '<p>Database not available.</p>';
             return;
         }

        try {
             const transaction = db.transaction(STORE_NAME, 'readonly');
             const store = transaction.objectStore(STORE_NAME);
             const index = store.index('surah');
             const request = index.getAll(surahNumber);

             request.onsuccess = () => {
                 const ayahs = request.result.sort((a, b) => a.ayah - b.ayah); // Ensure order
                 renderAyahs(ayahs, ayahListEl);
                 hideLoader();

                 const mainContent = document.querySelector('.main-content');
                 const scrollPos = sessionStorage.getItem(`scroll_surah_${surahNumber}`);
                 if (scrollPos) {
                      mainContent.scrollTop = parseInt(scrollPos, 10);
                 } else {
                      mainContent.scrollTop = 0; // Scroll to top for new surah
                 }

                if (lastRead.surah === surahNumber && lastRead.ayah !== null && lastRead.id !== null) {
                     const lastReadEl = ayahListEl.querySelector(`[data-id="${lastRead.id}"]`);
                     if (lastReadEl) {
                         setTimeout(() => { // Ensure layout complete
                             lastReadEl.scrollIntoView({ behavior: 'smooth', block: 'center' });
                         }, 150);
                     }
                 }
             };
             request.onerror = (event) => {
                 console.error('Error fetching ayahs:', event.target.error);
                 hideLoader();
                 ayahListEl.innerHTML = '<p>Error loading Ayahs.</p>';
             };
         } catch (e) {
             console.error("Error creating transaction for loading ayahs:", e);
             hideLoader();
             ayahListEl.innerHTML = '<p>Error accessing database.</p>';
         }
    }

    function renderAyahs(ayahs, container, searchTerm = null) {
         container.innerHTML = ''; // Clear previous content
         const fragment = document.createDocumentFragment();
         ayahs.forEach(ayah => {
            const li = document.createElement('li');
            li.className = 'ayah-item';
            li.dataset.id = ayah.id;
            li.dataset.surah = ayah.surah;
            li.dataset.ayah = ayah.ayah;
            if (ayah.read) li.classList.add('read');

             let arabicText = ayah.arabic || '';
             let urduText = ayah.urdu || '';

             if (searchTerm) {
                try {
                     // Escape special regex characters in the search term
                     const escapedSearchTerm = searchTerm.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                     const regex = new RegExp(`(${escapedSearchTerm})`, 'gi');
                     arabicText = arabicText.replace(regex, '<mark>$1</mark>');
                     urduText = urduText.replace(regex, '<mark>$1</mark>');
                 } catch (e) {
                     console.warn("Regex error during highlighting:", e);
                     // Fallback to no highlighting if regex fails
                 }
             }

            li.innerHTML = `
                <div class="ayah-header">
                    <span>${ayah.surah}:${ayah.ayah}</span>
                    <div class="ayah-controls">
                        <button class="bookmark-btn ${ayah.bookmarked ? 'active' : ''}" title="Bookmark">
                            <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M17 3H7c-1.1 0-2 .9-2 2v16l7-3 7 3V5c0-1.1-.9-2-2-2zm0 15l-5-2.18L7 18V5h10v13z"/></svg>
                         </button>
                        <button class="read-toggle-btn ${ayah.read ? 'active' : ''}" title="${ayah.read ? 'Mark as Unread' : 'Mark as Read'}">
                             <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M9 16.17 4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg>
                         </button>
                         <button class="read-mode-btn" title="Reading Mode">
                              <svg viewBox="0 0 24 24" width="18" height="18" fill="currentColor"><path d="M19 19H5V5h7V3H5c-1.11 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-7h-2v7zM14 3v2h3.59l-9.83 9.83 1.41 1.41L19 6.41V10h2V3h-7z"/></svg>
                          </button>
                    </div>
                </div>
                <p class="ayah-text-arabic" dir="rtl">${arabicText}</p>
                <p class="ayah-text-urdu" dir="rtl">${urduText}</p>
            `;

            const bookmarkBtn = li.querySelector('.bookmark-btn');
            const readToggleBtn = li.querySelector('.read-toggle-btn');
            const readModeBtn = li.querySelector('.read-mode-btn');

            if (bookmarkBtn) {
                 bookmarkBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggleBookmark(ayah.id, bookmarkBtn);
                });
             }
            if (readToggleBtn) {
                readToggleBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                    toggleReadStatus(ayah.id, li);
                    saveLastReadPosition(ayah.surah, ayah.ayah, ayah.id); // Update last read on manual toggle
                 });
            }
            if (readModeBtn) {
                readModeBtn.addEventListener('click', (e) => {
                    e.stopPropagation();
                     enterReadingMode(ayah.id);
                 });
             }
            li.addEventListener('click', () => {
                 saveLastReadPosition(ayah.surah, ayah.ayah, ayah.id);
             });

            fragment.appendChild(li);
        });
        container.appendChild(fragment);
    }

    function updateAyahUI(id, updates) {
        // Update in Ayah list view
        const ayahItem = ayahListEl.querySelector(`.ayah-item[data-id="${id}"]`);
        if (ayahItem) {
             updateSingleAyahItemUI(ayahItem, updates);
        }
        // Update in search results view
         const searchItem = searchResultsEl.querySelector(`.ayah-item[data-id="${id}"]`);
        if (searchItem) {
             updateSingleAyahItemUI(searchItem, updates);
         }
        // Update in bookmarks view
         const bookmarkItem = bookmarkListEl.querySelector(`.ayah-item[data-id="${id}"]`);
        if (bookmarkItem) {
            updateSingleAyahItemUI(bookmarkItem, updates);
            // If bookmark removed, remove from list if on bookmarks page
             if (updates.hasOwnProperty('bookmarked') && !updates.bookmarked && document.getElementById('page-bookmarks').classList.contains('active')) {
                 bookmarkItem.remove();
                 // Check if list is now empty
                 if (bookmarkListEl.children.length === 0) {
                    noBookmarksMsg.style.display = 'block';
                 }
             }
         }
     }

     function updateSingleAyahItemUI(itemElement, updates) {
         if (updates.hasOwnProperty('bookmarked')) {
             const btn = itemElement.querySelector('.bookmark-btn');
             if (btn) {
                 btn.classList.toggle('active', !!updates.bookmarked);
             }
         }
         if (updates.hasOwnProperty('read')) {
             const btn = itemElement.querySelector('.read-toggle-btn');
             itemElement.classList.toggle('read', !!updates.read);
             if (btn) {
                 btn.classList.toggle('active', !!updates.read);
                 btn.title = updates.read ? 'Mark as Unread' : 'Mark as Read';
             }
         }
     }


     function updateAyahData(id, updates) {
        return new Promise((resolve, reject) => {
             if (!db) return reject("DB not initialized");
             try {
                const transaction = db.transaction(STORE_NAME, 'readwrite');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.get(id);

                request.onsuccess = () => {
                    const data = request.result;
                    if (!data) return reject("Ayah not found");

                    Object.assign(data, updates); // Apply updates

                    const updateRequest = store.put(data);
                    updateRequest.onsuccess = () => {
                        updateAyahUI(id, updates); // Update UI immediately
                        resolve();
                    };
                    updateRequest.onerror = (event) => reject(event.target.error);
                };
                request.onerror = (event) => reject(event.target.error);

                transaction.onerror = (event) => {
                    console.error("Transaction error in updateAyahData:", event.target.error);
                    reject(event.target.error);
                };
            } catch (e) {
                reject(`Error creating transaction for update: ${e}`);
            }
        });
    }

    async function toggleBookmark(id, button) {
        const isActive = button.classList.contains('active');
        try {
             await updateAyahData(id, { bookmarked: isActive ? 0 : 1 });
             console.log(`Ayah ${id} bookmark status updated.`);
        } catch (error) {
             console.error('Failed to toggle bookmark:', error);
         }
     }

    async function toggleReadStatus(id, listItem) {
         const isRead = listItem.classList.contains('read');
         try {
             await updateAyahData(id, { read: isRead ? 0 : 1 });
             console.log(`Ayah ${id} read status updated.`);
             updateProgress(); // Update progress bar
         } catch (error) {
             console.error('Failed to toggle read status:', error);
         }
     }

     function updateProgress() {
         if (!db || !db.objectStoreNames.contains(STORE_NAME) || actualTotalAyahs === 0) {
             // Set progress to 0 if DB not ready or empty
              progressBarInner.style.width = `0%`;
              progressText.textContent = `0% (0/${actualTotalAyahs || '?'}) Read`;
             return;
          }

         try {
            const transaction = db.transaction(STORE_NAME, 'readonly');
            const store = transaction.objectStore(STORE_NAME);
            const readIndex = store.index('read');
            const readCountRequest = readIndex.count(1); // Count only read items (where read = 1)

            readCountRequest.onsuccess = () => {
                const readCount = readCountRequest.result;
                 // Recalculate total count just in case it changed (unlikely but safe)
                 const totalCountRequest = store.count();
                 totalCountRequest.onsuccess = () => {
                     actualTotalAyahs = totalCountRequest.result;
                     const percentage = actualTotalAyahs > 0 ? Math.round((readCount / actualTotalAyahs) * 100) : 0;
                     progressBarInner.style.width = `${percentage}%`;
                     progressText.textContent = `${percentage}% (${readCount}/${actualTotalAyahs}) Read`;
                     console.log(`Progress updated: ${percentage}%`);
                 };
                 totalCountRequest.onerror = (event) => {
                     console.error('Error getting total count for progress:', event.target.error);
                     // Use previous actualTotalAyahs as fallback
                     const percentage = actualTotalAyahs > 0 ? Math.round((readCount / actualTotalAyahs) * 100) : 0;
                     progressBarInner.style.width = `${percentage}%`;
                     progressText.textContent = `${percentage}% (${readCount}/${actualTotalAyahs}) Read`;
                 };
             };
            readCountRequest.onerror = (event) => {
                console.error('Error counting read ayahs:', event.target.error);
             };
         } catch(e) {
              console.error("Error creating transaction for progress update:", e);
          }
     }

     function performSearch(query) {
        searchResultsEl.innerHTML = '<p>Searching...</p>';
        searchSuggestionsEl.style.display = 'none'; // Hide suggestions when showing results
        searchSuggestionsEl.innerHTML = '';

        if (!query || query.length < 2) {
             searchResultsEl.innerHTML = '';
             return;
         }

         if (!db || !db.objectStoreNames.contains(STORE_NAME)) {
             searchResultsEl.innerHTML = '<p>Database not available for search.</p>';
             return;
         }

         try {
            const transaction = db.transaction(STORE_NAME, 'readonly');
            const store = transaction.objectStore(STORE_NAME);
            const results = [];
            const lowerQuery = query.toLowerCase(); // Case-insensitive search prep

            let cursorRequest = store.openCursor(); // Iterate through all items
            const MAX_RESULTS = 100; // Limit results for performance

            cursorRequest.onsuccess = (event) => {
                const cursor = event.target.result;
                if (cursor && results.length < MAX_RESULTS) {
                    const ayah = cursor.value;
                    let match = false;
                    // Check both Arabic and Urdu text, case-insensitively for Urdu/English
                    if (ayah.arabic && ayah.arabic.includes(query)) { // Arabic match (exact case or use specific collation if needed)
                        match = true;
                    } else if (ayah.urdu && ayah.urdu.toLowerCase().includes(lowerQuery)) { // Urdu match (case-insensitive)
                         match = true;
                     }

                    if (match) {
                        results.push(ayah);
                    }
                    cursor.continue();
                } else {
                    // Cursor finished or limit reached
                    renderSearchResults(results, query);
                }
            };
            cursorRequest.onerror = (event) => {
                console.error('Search error:', event.target.error);
                searchResultsEl.innerHTML = '<p>Error during search.</p>';
            };
         } catch(e) {
              console.error("Error creating transaction for search:", e);
              searchResultsEl.innerHTML = '<p>Error accessing database for search.</p>';
          }
     }

     function performSuggestionSearch(query) {
         searchSuggestionsEl.innerHTML = '';
         searchSuggestionsEl.style.display = 'none';

         if (!query || query.length < 2) {
             return;
         }
          if (!db || !db.objectStoreNames.contains(STORE_NAME)) return;

        try {
            const transaction = db.transaction(STORE_NAME, 'readonly');
            const store = transaction.objectStore(STORE_NAME);
            const suggestions = [];
            const addedAyahIds = new Set(); // Avoid duplicate suggestions from same Ayah
            const lowerQuery = query.toLowerCase();
            const MAX_SUGGESTIONS = 10;

            const isLikelyArabic = /[\u0600-\u06FF]/.test(query);
             // Search both indexes for broader suggestions initially
            let arabicIndex = store.index('arabic');
             let urduIndex = store.index('urdu');
             let arabicCursorReq = arabicIndex.openCursor(); // Check full Arabic text
             let urduCursorReq = urduIndex.openCursor();     // Check full Urdu text

            const processCursor = (cursor, fieldName) => {
                if (cursor && suggestions.length < MAX_SUGGESTIONS) {
                     const ayah = cursor.value;
                     const text = ayah[fieldName];
                     const matchIndex = fieldName === 'urdu' ? text.toLowerCase().indexOf(lowerQuery) : text.indexOf(query); // Case-sensitive for Arabic? Adjust if needed.

                     if (matchIndex > -1 && !addedAyahIds.has(ayah.id)) {
                         const snippetLength = 50;
                         let start = Math.max(0, matchIndex - Math.floor(snippetLength/3));
                         let end = Math.min(text.length, matchIndex + query.length + Math.ceil(snippetLength*2/3));
                         let snippet = (start > 0 ? '...' : '') + text.substring(start, end) + (end < text.length ? '...' : '');

                         try {
                             const escapedQuery = query.replace(/[.*+?^${}()|[\]\\]/g, '\\$&');
                             const regex = new RegExp(`(${escapedQuery})`, 'gi');
                             snippet = snippet.replace(regex, '<mark>$1</mark>');
                         } catch (e) { /* ignore regex error */ }

                         suggestions.push({ text: snippet, fullText: text, ayah: ayah });
                         addedAyahIds.add(ayah.id);
                     }
                     cursor.continue();
                 }
             };

            let arabicDone = false;
             let urduDone = false;

             arabicCursorReq.onsuccess = (event) => {
                 processCursor(event.target.result, 'arabic');
                 if (!event.target.result) { // Cursor finished
                     arabicDone = true;
                     if (urduDone) renderSuggestions(suggestions, query);
                 }
             };
             urduCursorReq.onsuccess = (event) => {
                 processCursor(event.target.result, 'urdu');
                 if (!event.target.result) { // Cursor finished
                     urduDone = true;
                     if (arabicDone) renderSuggestions(suggestions, query);
                 }
             };

             arabicCursorReq.onerror = urduCursorReq.onerror = (event) => {
                  console.error('Suggestion search cursor error:', event.target.error);
                  // Mark as done on error to potentially render results from the other cursor
                  if (event.target === arabicCursorReq) arabicDone = true;
                  if (event.target === urduCursorReq) urduDone = true;
                  if (arabicDone && urduDone) renderSuggestions(suggestions, query);
              };

         } catch(e) {
             console.error("Error creating transaction for suggestion search:", e);
         }
     }


     function renderSuggestions(suggestions, query) {
         searchSuggestionsEl.innerHTML = '';
         // Deduplicate suggestions based on Ayah ID before rendering
         const uniqueSuggestions = Array.from(new Map(suggestions.map(s => [s.ayah.id, s])).values());

         if (uniqueSuggestions.length > 0) {
             uniqueSuggestions.slice(0, 10).forEach(suggestion => { // Limit rendered suggestions
                 const li = document.createElement('li');
                 li.innerHTML = `(${suggestion.ayah.surah}:${suggestion.ayah.ayah}) ${suggestion.text}`; // Add reference
                 li.addEventListener('click', () => {
                      searchInput.value = query;
                      performSearch(query); // Perform full search based on original query
                 });
                 searchSuggestionsEl.appendChild(li);
             });
             searchSuggestionsEl.style.display = 'block';
         } else {
             searchSuggestionsEl.style.display = 'none';
         }
     }

     function renderSearchResults(results, query) {
        if (results.length > 0) {
             renderAyahs(results, searchResultsEl, query); // Use renderAyahs with highlighting
         } else {
             searchResultsEl.innerHTML = `<p>No results found for "${query}".</p>`;
         }
     }


     function loadBookmarks() {
         showLoader('Loading Bookmarks...');
         bookmarkListEl.innerHTML = '';
         noBookmarksMsg.style.display = 'none';

         if (!db || !db.objectStoreNames.contains(STORE_NAME)) {
             hideLoader();
             noBookmarksMsg.textContent = 'Database not available.';
             noBookmarksMsg.style.display = 'block';
             return;
         }

         try {
            const transaction = db.transaction(STORE_NAME, 'readonly');
            const store = transaction.objectStore(STORE_NAME);
            const index = store.index('bookmarked');
            const request = index.getAll(1); // Get all where bookmarked = 1

            request.onsuccess = () => {
                const bookmarks = request.result.sort((a, b) => a.surah === b.surah ? a.ayah - b.ayah : a.surah - b.surah); // Sort them
                if (bookmarks.length > 0) {
                   renderAyahs(bookmarks, bookmarkListEl); // Reuse Ayah rendering
                   noBookmarksMsg.style.display = 'none';
                } else {
                   noBookmarksMsg.textContent = 'No bookmarks added yet.';
                   noBookmarksMsg.style.display = 'block';
                }
                hideLoader();
            };
            request.onerror = (event) => {
                console.error('Error fetching bookmarks:', event.target.error);
                 bookmarkListEl.innerHTML = '<p>Error loading bookmarks.</p>';
                 noBookmarksMsg.style.display = 'none';
                hideLoader();
            };
         } catch(e) {
             console.error("Error creating transaction for loading bookmarks:", e);
             hideLoader();
             bookmarkListEl.innerHTML = '<p>Error accessing database.</p>';
             noBookmarksMsg.style.display = 'none';
         }
     }


    function applySettings(settings) {
         // Theme
         body.dataset.theme = settings.theme;
         darkModeToggle.checked = settings.theme === 'dark';

         // Font Size
         body.dataset.fontSize = settings.fontSize;
         let fontSizeVal = '16px'; // medium
         let arabicMultiplier = 1.8;
         let urduMultiplier = 1.2;
         switch (settings.fontSize) {
             case 'small': fontSizeVal = '14px'; arabicMultiplier = 1.6; urduMultiplier = 1.1; break;
             case 'large': fontSizeVal = '18px'; arabicMultiplier = 2.0; urduMultiplier = 1.3; break;
         }
         document.documentElement.style.setProperty('--font-size-base', fontSizeVal);
         document.documentElement.style.setProperty('--font-size-arabic', `${arabicMultiplier}rem`);
         document.documentElement.style.setProperty('--font-size-urdu', `${urduMultiplier}rem`);

         fontSizeControls.querySelectorAll('button').forEach(btn => {
             btn.classList.toggle('active', btn.dataset.size === settings.fontSize);
         });

        // Language Display
         body.dataset.display = settings.display;
         languageToggleControls.querySelectorAll('button').forEach(btn => {
             btn.classList.toggle('active', btn.dataset.display === settings.display);
         });

         // Update reading mode display if active
         if (readingModeActive) {
             readingArabicEl.style.display = (settings.display === 'arabic' || settings.display === 'both') ? 'block' : 'none';
             readingUrduEl.style.display = (settings.display === 'urdu' || settings.display === 'both') ? 'block' : 'none';
         }
     }

     async function loadAndApplySettings() {
         try {
            const theme = await getSetting('theme');
            const fontSize = await getSetting('fontSize');
            const display = await getSetting('display');

            currentSettings.theme = theme || 'light'; // Default to light
            currentSettings.fontSize = fontSize || 'medium';
            currentSettings.display = display || 'both';

            applySettings(currentSettings);
            console.log("Settings loaded and applied:", currentSettings);

         } catch (error) {
             console.error("Failed to load settings:", error);
              // Apply defaults if loading fails
             applySettings(currentSettings);
         }
     }

    async function saveSettings() {
         try {
             await setSetting('theme', currentSettings.theme);
             await setSetting('fontSize', currentSettings.fontSize);
             await setSetting('display', currentSettings.display);
             console.log("Settings saved:", currentSettings);
         } catch (error) {
             console.error("Failed to save settings:", error);
         }
     }

     function saveLastReadPosition(surah, ayah, id) {
        if (id === null || id === undefined) {
             console.warn("Attempted to save last read position with invalid ID.");
             return;
        }
        lastRead = { surah, ayah, id };
        setSetting('lastRead', lastRead)
            .then(() => {
                 console.log(`Last read position saved: Surah ${surah}, Ayah ${ayah}, ID ${id}`);
                 loadLastReadInfo(); // Update info on home page
             })
             .catch(err => console.error('Failed to save last read position:', err));
     }

    async function loadLastReadInfo() {
         try {
             const savedLastRead = await getSetting('lastRead');
             if (savedLastRead && savedLastRead.surah && savedLastRead.ayah && savedLastRead.id !== undefined && savedLastRead.id !== null) {
                 lastRead = savedLastRead;
                 lastReadInfo.textContent = `Surah ${surahNames[lastRead.surah - 1] || lastRead.surah} (${lastRead.surah}), Ayah ${lastRead.ayah}`;
                 resumeReadingBtn.style.display = 'inline-block';
             } else {
                 lastRead = { surah: null, ayah: null, id: null }; // Reset if invalid
                 lastReadInfo.textContent = 'Not started yet.';
                 resumeReadingBtn.style.display = 'none';
             }
         } catch (error) {
             console.error('Failed to load last read position:', error);
             lastReadInfo.textContent = 'Could not load last read position.';
             resumeReadingBtn.style.display = 'none';
         }
     }

    function getAyahById(id) {
         return new Promise((resolve, reject) => {
             if (!db) return reject("DB not initialized");
             if (id === null || id === undefined) return reject("Invalid ID provided to getAyahById");

            try {
                const transaction = db.transaction(STORE_NAME, 'readonly');
                const store = transaction.objectStore(STORE_NAME);
                const request = store.get(id);
                request.onsuccess = () => resolve(request.result); // Result might be undefined if not found
                request.onerror = (event) => reject(event.target.error);
            } catch (e) {
                reject(`Error creating transaction for getAyahById: ${e}`);
            }
         });
     }

     function getAdjacentAyahId(currentId, direction) {
         // direction: 'next' or 'prev'
         return new Promise(async (resolve, reject) => {
             if (!db) return reject("DB not initialized");
             if (currentId === null || currentId === undefined) return reject("Invalid currentId provided");

             try {
                 const currentAyahData = await getAyahById(currentId);
                 if (!currentAyahData) return reject("Current Ayah data not found for ID: " + currentId);

                 const transaction = db.transaction(STORE_NAME, 'readonly');
                 const store = transaction.objectStore(STORE_NAME);
                 const index = store.index('surah_ayah');

                 let range;
                 let cursorDirection;

                 if (direction === 'next') {
                     range = IDBKeyRange.lowerBound([currentAyahData.surah, currentAyahData.ayah], true); // Start from current Ayah+Surah, exclude current
                     cursorDirection = 'next';
                 } else { // 'prev'
                     range = IDBKeyRange.upperBound([currentAyahData.surah, currentAyahData.ayah], true); // End at current Ayah+Surah, exclude current
                     cursorDirection = 'prev';
                 }

                 const request = index.openCursor(range, cursorDirection);
                 let foundAdjacent = false;

                 request.onsuccess = (event) => {
                     const cursor = event.target.result;
                     if (cursor) {
                          // Skip the current item itself
                          if (cursor.value.id === currentId) {
                              cursor.continue();
                              return;
                          }
                         // Found the next/previous item
                         resolve(cursor.value.id);
                         foundAdjacent = true;
                     } else {
                         // Cursor finished without finding adjacent in range (implies end/beginning of Quran)
                         if (!foundAdjacent) {
                            resolve(null); // Indicate no more ayahs in this direction
                         }
                     }
                 };
                 request.onerror = (event) => reject(event.target.error);

             } catch (error) {
                 reject(`Error in getAdjacentAyahId: ${error}`);
             }
         });
     }


    async function enterReadingMode(ayahId) {
         if (ayahId === null || ayahId === undefined) {
             console.warn("Cannot enter reading mode with invalid Ayah ID.");
             return;
         }
         try {
             const ayah = await getAyahById(ayahId);
             if (!ayah) {
                 console.error("Ayah data not found for ID:", ayahId);
                 return;
             }

             readingModeCurrentId = ayah.id;
             readingArabicEl.textContent = ayah.arabic || '';
             readingUrduEl.textContent = ayah.urdu || '';

             readingArabicEl.style.display = (currentSettings.display === 'arabic' || currentSettings.display === 'both') ? 'block' : 'none';
             readingUrduEl.style.display = (currentSettings.display === 'urdu' || currentSettings.display === 'both') ? 'block' : 'none';

             readingModeEl.style.display = 'flex';
             readingModeActive = true;
             document.body.style.overflow = 'hidden';

             if (!ayah.read) {
                await updateAyahData(ayah.id, { read: 1 });
                updateProgress();
             }
             saveLastReadPosition(ayah.surah, ayah.ayah, ayah.id);

         } catch (error) {
             console.error("Error entering reading mode:", error);
         }
     }

     function exitReadingMode() {
         readingModeEl.style.display = 'none';
         readingModeActive = false;
         readingModeCurrentId = null;
         document.body.style.overflow = ''; // Restore background scroll
         // Update the UI in the list view for the last read item if necessary
          if (lastRead.id !== null) {
             updateAyahUI(lastRead.id, { read: 1 }); // Ensure it's marked read visually
          }
      }

    async function navigateReadingMode(direction) {
         if (!readingModeCurrentId) return;

         showLoader("Loading..."); // Indicate loading next/prev
         let adjacentId = null;
         try {
             adjacentId = await getAdjacentAyahId(readingModeCurrentId, direction);

             if (adjacentId !== null) {
                 await enterReadingMode(adjacentId); // Re-enter updates content, marks read, saves pos
             } else {
                 console.log(`Reached ${direction === 'next' ? 'end' : 'beginning'} of Quran.`);
                 // Optional feedback: flash screen briefly?
             }
         } catch (error) {
             console.error(`Error navigating ${direction} in reading mode:`, error);
         } finally {
             hideLoader();
         }
     }

    function handleTouchStart(event) {
        // Ensure the touch is primarily horizontal and within the reading mode area
        if (!readingModeActive) return;
         touchStartX = event.changedTouches[0].screenX;
     }

    function handleTouchEnd(event) {
         if (!readingModeActive || touchStartX === 0) return; // Ensure start event was captured
         touchEndX = event.changedTouches[0].screenX;
         handleSwipeGesture();
         touchStartX = 0; // Reset for next swipe
         touchEndX = 0;
     }

    function handleSwipeGesture() {
         const threshold = 50; // Minimum pixels swiped
         const deltaX = touchEndX - touchStartX;

         if (deltaX < -threshold) {
             navigateReadingMode('next'); // Swiped left
         } else if (deltaX > threshold) {
             navigateReadingMode('prev'); // Swiped right
         }
     }


    // --- Event Listeners ---
    document.addEventListener('DOMContentLoaded', async () => {
         showLoader('Initializing...');
         try {
             await initDB();
             await loadAndApplySettings(); // Load settings early

             const isPopulated = await checkDBPopulated(); // This also sets actualTotalAyahs

             if (!isPopulated) {
                  try {
                     await parseAndPopulateDB(); // This now handles its own completion logic
                  } catch (populationError) {
                       console.error("Critical error during database population:", populationError);
                       loaderText.textContent = `Error populating data: ${populationError}. Please reload.`;
                       return; // Stop initialization on critical population error
                   }
             } else {
                 console.log("Database already populated.");
                 updateProgress(); // Initial progress calculation needed if already populated
                 await loadLastReadInfo(); // Load last read info
             }

             // Ensure progress is updated even if population was skipped
             if (isPopulated) updateProgress();

             navigateToPage('home'); // Start at home page
             hideLoader();

             // Save scroll position for Ayah view
              const mainContent = document.querySelector('.main-content');
              if (mainContent) {
                 mainContent.addEventListener('scroll', (e) => {
                     if (currentSurah !== null && document.getElementById('page-ayahs').classList.contains('active')) {
                          sessionStorage.setItem(`scroll_surah_${currentSurah}`, e.target.scrollTop);
                      }
                  }, { passive: true }); // Use passive listener for scroll performance
             } else {
                 console.error("Main content area not found for scroll listener.");
             }

         } catch (error) {
             console.error('Initialization failed:', error);
             loaderText.textContent = 'Error initializing application. Please refresh.';
              // Keep loader visible on critical error
         }
    });

    navItems.forEach(item => {
         item.addEventListener('click', () => {
             navigateToPage(item.dataset.page);
         });
     });

    darkModeToggle.addEventListener('change', () => {
         currentSettings.theme = darkModeToggle.checked ? 'dark' : 'light';
         applySettings(currentSettings);
         saveSettings();
     });

    fontSizeControls.addEventListener('click', (e) => {
         if (e.target.tagName === 'BUTTON' && e.target.dataset.size) {
             currentSettings.fontSize = e.target.dataset.size;
             applySettings(currentSettings);
             saveSettings();
         }
     });

    languageToggleControls.addEventListener('click', (e) => {
         if (e.target.tagName === 'BUTTON' && e.target.dataset.display) {
             currentSettings.display = e.target.dataset.display;
             applySettings(currentSettings);
             saveSettings();
         }
     });

    searchInput.addEventListener('input', () => {
         clearTimeout(searchDebounceTimer);
         const query = searchInput.value.trim();
         searchResultsEl.innerHTML = ''; // Clear main results on input change
         searchDebounceTimer = setTimeout(() => {
             performSuggestionSearch(query);
         }, 350); // Slightly longer debounce for suggestions
     });

     searchInput.addEventListener('keypress', (e) => {
         if (e.key === 'Enter') {
             e.preventDefault(); // Prevent form submission if it were in a form
             clearTimeout(searchDebounceTimer);
             performSearch(searchInput.value.trim());
         }
     });

     searchInput.addEventListener('blur', () => {
         setTimeout(() => {
            // Check if the focus moved to a suggestion item or stayed within the suggestion box
             if (!searchSuggestionsEl.contains(document.activeElement)) {
                 searchSuggestionsEl.style.display = 'none';
             }
         }, 200);
     });
     // Keep suggestions visible if user clicks on one
     searchSuggestionsEl.addEventListener('mousedown', (e) => {
        // Prevent input blur event from hiding suggestions when clicking one
        e.preventDefault();
     });


    readingModeCloseBtn.addEventListener('click', exitReadingMode);
    readingNavPrev.addEventListener('click', () => navigateReadingMode('prev'));
    readingNavNext.addEventListener('click', () => navigateReadingMode('next'));
    readingModeEl.addEventListener('touchstart', handleTouchStart, { passive: true }); // Use passive for start
    readingModeEl.addEventListener('touchend', handleTouchEnd, false); // Not passive for end to potentially prevent default scroll

     resumeReadingBtn.addEventListener('click', () => {
         if (lastRead.id !== null) {
             enterReadingMode(lastRead.id);
         } else if (lastRead.surah && lastRead.ayah) {
            // Fallback: try to load surah view if ID is missing for some reason
             console.warn("Resuming reading, but ID missing. Loading Surah view.");
             loadAyahView(lastRead.surah);
         } else {
             console.warn("Cannot resume reading, no valid last read position found.");
         }
     });

     clearDataBtn.addEventListener('click', async () => {
         if (confirm('Are you sure you want to clear all Quran data, bookmarks, read status, and settings? This cannot be undone and will require reloading the app.')) {
             try {
                showLoader('Clearing data...');
                if (db) {
                     db.close(); // Important: Close the DB connection first
                     db = null; // Reset the db variable
                 }
                 const deleteRequest = indexedDB.deleteDatabase(DB_NAME);

                 deleteRequest.onsuccess = () => {
                     console.log('Database deleted successfully');
                     sessionStorage.clear(); // Clear session storage (scroll positions)
                     localStorage.clear(); // Clear local storage (just in case)
                     alert('Data cleared. The application will now reload.');
                     window.location.reload();
                 };
                 deleteRequest.onerror = (event) => {
                     console.error('Error deleting database:', event.target.error);
                     alert('Error clearing data. You might need to clear browser data manually.');
                      hideLoader();
                 };
                 deleteRequest.onblocked = () => {
                      console.warn('Database deletion blocked. Please close other tabs/windows using this app and try again.');
                      alert('Could not clear data because the database is still in use. Please close other instances of this app and reload, then try again.');
                      hideLoader();
                      // Re-attempt to open DB connection if blocked? Or just force reload?
                      // Forcing reload might resolve the block on next attempt.
                      // window.location.reload();
                  };
             } catch (error) {
                 console.error('Error initiating data clearing:', error);
                 alert('An error occurred while trying to clear data.');
                 hideLoader();
             }
         }
     });

</script>

</body>
</html>
