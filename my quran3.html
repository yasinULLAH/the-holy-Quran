<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, viewport-fit=cover">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Quran App</title>
    <style>
        :root {
            --bg-color-light: #e0e5ec; --text-color-light: #333; --primary-color-light: #6d5dfc; --highlight-color-light: rgba(109, 93, 252, 0.2); --neumorph-shadow-light-1: inset 5px 5px 10px #a3b1c6, inset -5px -5px 10px #ffffff; --neumorph-shadow-light-2: 5px 5px 10px #a3b1c6, -5px -5px 10px #ffffff; --glass-bg-light: rgba(255, 255, 255, 0.5); --glass-border-light: rgba(255, 255, 255, 0.3);
            --bg-color-dark: #1a1a1a; --text-color-dark: #e0e0e0; --primary-color-dark: #ffd700; --highlight-color-dark: rgba(255, 215, 0, 0.2); --neumorph-shadow-dark-1: inset 4px 4px 8px #0d0d0d, inset -4px -4px 8px #272727; --neumorph-shadow-dark-2: 4px 4px 8px #0d0d0d, -4px -4px 8px #272727; --glass-bg-dark: rgba(40, 40, 40, 0.6); --glass-border-dark: rgba(255, 215, 0, 0.2);
            --bg-color: var(--bg-color-light); --text-color: var(--text-color-light); --primary-color: var(--primary-color-light); --highlight-color: var(--highlight-color-light); --neumorph-shadow-1: var(--neumorph-shadow-light-1); --neumorph-shadow-2: var(--neumorph-shadow-light-2); --glass-bg: var(--glass-bg-light); --glass-border: var(--glass-border-light);
            /* Base font sizes */
            --font-size-base: 16px; --font-size-arabic-multiplier: 1.8; --font-size-urdu-multiplier: 1.2;
            /* Calculated sizes */
            --font-size-arabic: calc(var(--font-size-base) * var(--font-size-arabic-multiplier));
            --font-size-urdu: calc(var(--font-size-base) * var(--font-size-urdu-multiplier));
            --line-height-arabic: 2.5; --line-height-urdu: 1.8;
            /* Page mode reading font size adjustment */
            --page-mode-font-scale: 0.95; /* Slightly smaller for page mode */
            --bottom-nav-height: 60px; --header-height: 50px; --safe-area-top: env(safe-area-inset-top, 0px); --safe-area-bottom: env(safe-area-inset-bottom, 0px);
        }
        [data-theme="dark"] { --bg-color: var(--bg-color-dark); --text-color: var(--text-color-dark); --primary-color: var(--primary-color-dark); --highlight-color: var(--highlight-color-dark); --neumorph-shadow-1: var(--neumorph-shadow-dark-1); --neumorph-shadow-2: var(--neumorph-shadow-dark-2); --glass-bg: var(--glass-bg-dark); --glass-border: var(--glass-border-dark); }
        /* Font size adjustments based on settings */
        body[data-font-size="small"] { --font-size-base: 14px; --font-size-arabic-multiplier: 1.6; --font-size-urdu-multiplier: 1.1; }
        body[data-font-size="large"] { --font-size-base: 18px; --font-size-arabic-multiplier: 2.0; --font-size-urdu-multiplier: 1.3; }

        [lang="ur"] { --font-family-urdu: 'Noto Nastaliq Urdu', serif; font-family: var(--font-family-urdu); }
        [lang="en"] { --font-family-en: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, "Helvetica Neue", Arial, sans-serif; font-family: var(--font-family-en); }
        *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; -webkit-tap-highlight-color: transparent; }
        html { font-size: var(--font-size-base); scroll-behavior: smooth; }
        body { background-color: var(--bg-color); color: var(--text-color); transition: background-color 0.3s ease, color 0.3s ease; overscroll-behavior-y: contain; height: 100vh; width: 100vw; overflow: hidden; display: flex; flex-direction: column; }
        .app-container { display: flex; flex-direction: column; height: 100%; width: 100%; }
        .main-content { flex-grow: 1; overflow-y: auto; padding: calc(var(--header-height) + 10px + var(--safe-area-top)) 15px calc(var(--bottom-nav-height) + 10px + var(--safe-area-bottom)); position: relative; }
        .page { display: none; flex-direction: column; gap: 15px; }
        .page.active { display: flex; }
        .header { position: fixed; top: 0; left: 0; right: 0; height: calc(var(--header-height) + var(--safe-area-top)); padding-top: var(--safe-area-top); background: var(--glass-bg); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-bottom: 1px solid var(--glass-border); display: flex; align-items: center; justify-content: center; z-index: 100; transition: background 0.3s ease, border-color 0.3s ease; }
        .header-title { font-size: 1.2rem; font-weight: bold; color: var(--primary-color); }
        .bottom-nav { position: fixed; bottom: 0; left: 0; right: 0; height: calc(var(--bottom-nav-height) + var(--safe-area-bottom)); padding-bottom: var(--safe-area-bottom); background: var(--glass-bg); backdrop-filter: blur(10px); -webkit-backdrop-filter: blur(10px); border-top: 1px solid var(--glass-border); display: flex; justify-content: space-around; align-items: center; z-index: 100; transition: background 0.3s ease, border-color 0.3s ease; }
        .nav-item { display: flex; flex-direction: column; align-items: center; justify-content: center; background: none; border: none; color: var(--text-color); cursor: pointer; padding: 5px; font-size: 0.7rem; opacity: 0.7; transition: opacity 0.2s ease, color 0.2s ease; flex-grow: 1; height: 100%; white-space: nowrap; }
        .nav-item.active { opacity: 1; color: var(--primary-color); font-weight: bold; }
        .nav-item svg { width: 24px; height: 24px; margin-bottom: 2px; fill: currentColor; }
        .loader-container { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: var(--bg-color); display: flex; flex-direction: column; justify-content: center; align-items: center; z-index: 9999; text-align: center; padding: 20px;}
        .loader { border: 4px solid rgba(0,0,0,0.1); border-left-color: var(--primary-color); border-radius: 50%; width: 40px; height: 40px; animation: spin 1s linear infinite; } @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        .loader-text { margin-top: 15px; color: var(--text-color); }
        .surah-list, .ayah-list, .bookmark-list { list-style: none; padding: 0; margin: 0; display: flex; flex-direction: column; gap: 10px; }
        .list-item { background: var(--bg-color); padding: 15px; border-radius: 10px; box-shadow: var(--neumorph-shadow-2); cursor: pointer; transition: transform 0.2s ease, box-shadow 0.2s ease; display: flex; justify-content: space-between; align-items: center; }
        .list-item:active { transform: scale(0.98); box-shadow: var(--neumorph-shadow-1); }
        .surah-info { display: flex; align-items: center; gap: 10px; overflow: hidden; }
        .surah-number { background-color: var(--primary-color); color: var(--bg-color); border-radius: 50%; width: 30px; height: 30px; display: flex; align-items: center; justify-content: center; font-size: 0.8rem; font-weight: bold; flex-shrink: 0; }
        [data-theme="dark"] .surah-number { color: #000; }
        .surah-name { font-weight: bold; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .surah-details { font-size: 0.8rem; opacity: 0.7; flex-shrink: 0; }
        .ayah-item { background: var(--bg-color); padding: 15px; border-radius: 10px; box-shadow: var(--neumorph-shadow-2); margin-bottom: 15px; transition: box-shadow 0.3s ease; position: relative; }
        .ayah-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; opacity: 0.8; font-size: 0.9rem; }
        .ayah-controls { display: flex; gap: 5px; }
        .ayah-controls button { background: none; border: none; cursor: pointer; color: var(--text-color); padding: 5px; opacity: 0.7; display: inline-flex; align-items: center; justify-content: center; width: 28px; height: 28px;}
        .ayah-controls button svg { width: 18px; height: 18px; }
        .ayah-controls button.active { color: var(--primary-color); opacity: 1; }
        .ayah-text-arabic { font-size: var(--font-size-arabic); line-height: var(--line-height-arabic); text-align: right; margin-bottom: 10px; direction: rtl; font-family: 'Amiri Quran', serif; }
        .ayah-text-urdu { font-size: var(--font-size-urdu); line-height: var(--line-height-urdu); text-align: right; direction: rtl; font-family: 'Noto Nastaliq Urdu', serif; }
        .ayah-item.read { border-left: 5px solid var(--primary-color); opacity: 0.8; }
        .ayah-item mark { background-color: var(--highlight-color); padding: 0.1em 0; border-radius: 3px; }
        .search-input-container { position: relative; margin-bottom: 15px; }
        .search-input { width: 100%; padding: 15px 20px; border-radius: 25px; border: none; background: var(--bg-color); box-shadow: var(--neumorph-shadow-1); font-size: 1rem; color: var(--text-color); outline: none; transition: box-shadow 0.3s ease; }
        body[lang="ur"] .search-input { direction: rtl; text-align: right;}
        .search-input:focus { box-shadow: var(--neumorph-shadow-2); }
        #search-suggestions { list-style: none; padding: 0; margin: 5px 0 0 0; position: absolute; width: 100%; max-height: 300px; overflow-y: auto; background: var(--glass-bg); backdrop-filter: blur(5px); -webkit-backdrop-filter: blur(5px); border: 1px solid var(--glass-border); border-radius: 10px; z-index: 50; box-shadow: 0 4px 15px rgba(0,0,0,0.1); text-align: right; /* Default */ }
        body[lang="en"] #search-suggestions { text-align: left; }
        #search-suggestions li { padding: 10px 15px; cursor: pointer; border-bottom: 1px solid var(--glass-border); } #search-suggestions li:last-child { border-bottom: none; } #search-suggestions li:hover { background: var(--highlight-color); } #search-suggestions mark { background: none; color: var(--primary-color); font-weight: bold; }
        .settings-item { display: flex; justify-content: space-between; align-items: center; padding: 15px 0; border-bottom: 1px solid rgba(128, 128, 128, 0.2); flex-wrap: wrap; gap: 10px;}
        .settings-item:last-child { border-bottom: none; }
        .settings-item label { font-weight: bold; margin-right: auto;}
        .toggle-switch { position: relative; display: inline-block; width: 50px; height: 26px; } .toggle-switch input { opacity: 0; width: 0; height: 0; }
        .slider { position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0; background-color: #ccc; border-radius: 26px; transition: .4s; box-shadow: var(--neumorph-shadow-1); }
        .slider:before { position: absolute; content: ""; height: 20px; width: 20px; left: 3px; bottom: 3px; background-color: white; border-radius: 50%; transition: .4s; box-shadow: var(--neumorph-shadow-2); }
        input:checked + .slider { background-color: var(--primary-color); } input:checked + .slider:before { transform: translateX(24px); }
        .font-size-control, .language-toggle, .ui-language-toggle, .reading-mode-type-toggle { display: flex; gap: 10px; align-items: center; }
        .font-size-control button, .language-toggle button, .ui-language-toggle button, .reading-mode-type-toggle button { padding: 5px 10px; border: none; border-radius: 5px; background: var(--bg-color); box-shadow: var(--neumorph-shadow-2); cursor: pointer; transition: box-shadow 0.2s ease, background-color 0.2s ease; color: var(--text-color); min-width: 40px; text-align: center; }
        .font-size-control button:active, .language-toggle button:active, .ui-language-toggle button:active, .reading-mode-type-toggle button:active { box-shadow: var(--neumorph-shadow-1); }
        .language-toggle button.active, .ui-language-toggle button.active, .reading-mode-type-toggle button.active { background-color: var(--primary-color); color: var(--bg-color); }
        [data-theme="dark"] .language-toggle button.active, [data-theme="dark"] .ui-language-toggle button.active, [data-theme="dark"] .reading-mode-type-toggle button.active { color: #000; }
        #lines-per-page-input { width: 60px; padding: 5px; box-shadow: var(--neumorph-shadow-1); background: var(--bg-color); border: none; border-radius: 5px; color: var(--text-color); text-align: center; }
        .progress-container { margin-top: 10px; } .progress-bar { width: 100%; height: 8px; background-color: rgba(128, 128, 128, 0.2); border-radius: 4px; overflow: hidden; margin-top: 5px; } .progress-bar-inner { height: 100%; width: 0%; background-color: var(--primary-color); border-radius: 4px; transition: width 0.5s ease; } .progress-text { text-align: center; font-size: 0.8rem; margin-top: 5px; opacity: 0.8; }

        /* Reading Mode Base Styles */
        .reading-mode { position: fixed; top: 0; left: 0; width: 100vw; height: 100vh; background-color: var(--bg-color); z-index: 1000; display: none; flex-direction: column; justify-content: flex-start; /* Align top */ align-items: center; padding: 0; /* Remove padding */ touch-action: pan-y; overflow: hidden; }
        .reading-controls-top { position: absolute; top: calc(10px + var(--safe-area-top)); right: 10px; display: flex; gap: 10px; z-index: 1002;}
        .reading-controls-top button { background: none; border: none; color: var(--text-color); font-size: 1.5rem; cursor: pointer; opacity: 0.6; padding: 5px;}
        .reading-content { width: 100%; height: 100%; /* Full height initially */ text-align: center; overflow-x: hidden; padding: calc(50px + var(--safe-area-top)) 15px calc(40px + var(--safe-area-bottom)) 15px; scroll-behavior: smooth;}
        .reading-nav-overlay { position: absolute; top: 0; bottom: 0; width: 30%; cursor: pointer; z-index: 1; }
        .reading-nav-prev { left: 0; } .reading-nav-next { right: 0; }
        .swipe-indicator { position: absolute; bottom: calc(10px + var(--safe-area-bottom)); left: 50%; transform: translateX(-50%); font-size: 0.8rem; opacity: 0.5; z-index: 1001;}

        /* Ayah Reading Mode Specific Styles */
        .reading-mode.mode-ayah .reading-content { display: flex; flex-direction: column; justify-content: center; align-items: center; overflow-y: hidden; /* No vertical scroll */ }
        .reading-mode.mode-ayah .reading-ayah-arabic { font-size: calc(var(--font-size-arabic) * 1.1); line-height: calc(var(--line-height-arabic) * 1); margin-bottom: 20px; }
        .reading-mode.mode-ayah .reading-ayah-urdu { font-size: calc(var(--font-size-urdu) * 1); line-height: calc(var(--line-height-urdu) * 1); }

        /* Page Reading Mode Specific Styles */
        .reading-mode.mode-page .reading-content { text-align: right; overflow-y: auto; /* Allow vertical scroll IF content overflows */ }
        .reading-mode.mode-page .reading-ayah-item { margin-bottom: 15px; border-bottom: 1px solid var(--glass-border); padding-bottom: 10px; }
        .reading-mode.mode-page .reading-ayah-item:last-child { border-bottom: none; margin-bottom: 0;}
        .reading-mode.mode-page .reading-ayah-ref { font-size: 0.8em; opacity: 0.6; text-align: left; margin-bottom: 5px; }
        .reading-mode.mode-page .reading-ayah-arabic { text-align: right; margin-bottom: 8px; font-size: calc(var(--font-size-arabic) * var(--page-mode-font-scale)); line-height: calc(var(--line-height-arabic) * 0.95); /* Slightly reduced line height */ }
        .reading-mode.mode-page .reading-ayah-urdu { text-align: right; margin-bottom: 0; font-size: calc(var(--font-size-urdu) * var(--page-mode-font-scale)); line-height: calc(var(--line-height-urdu) * 0.95); }

        [data-display="arabic"] .ayah-text-urdu, [data-display="arabic"] .reading-ayah-urdu { display: none; }
        [data-display="urdu"] .ayah-text-arabic, [data-display="urdu"] .reading-ayah-arabic { display: none; }
        [data-display="both"] .ayah-text-arabic, [data-display="both"] .ayah-text-urdu, [data-display="both"] .reading-ayah-arabic, [data-display="both"] .reading-ayah-urdu { display: block; }
        @font-face { font-family: 'Amiri Quran'; src: url('https://fonts.gstatic.com/s/amiriquran/v6/XZuz_gLSbMAb2JNdAJcQ7fD8.woff2') format('woff2'); unicode-range: U+0600-06FF, U+0750-077F, U+08A0-08FF, U+FB50-FDFF, U+FE70-FEFF; font-display: swap; }
        @font-face { font-family: 'Noto Nastaliq Urdu'; src: url('https://fonts.gstatic.com/s/notonastaliqurdu/v14/XRXJrd4E-HPER4aTA_RTl2Hr7CH6wL-N.woff2') format('woff2'); unicode-range: U+0600-06FF, U+0750-077F, U+FB50-FDFF, U+FE70-FEFF; font-display: swap; }
    </style>
</head>
<body data-theme="light" data-font-size="medium" data-display="both" lang="en">

    <div class="app-container">
        <header class="header"> <span class="header-title" data-translate-key="app_title">Quran App</span> </header>
        <main class="main-content">
            <div id="page-home" class="page active">
                <h2 data-translate-key="home_welcome">Welcome</h2>
                <p data-translate-key="home_start_journey">Start your Quran journey.</p>
                <div class="progress-container">
                    <h3 data-translate-key="home_progress">Reading Progress</h3>
                    <div class="progress-bar"> <div class="progress-bar-inner" id="progress-bar-inner"></div> </div>
                    <p class="progress-text" id="progress-text">0%</p>
                </div>
                <div>
                    <h3 data-translate-key="home_last_read">Last Read</h3>
                    <p id="last-read-info" data-translate-key="last_read_empty">Not started yet.</p>
                    <button id="resume-reading-btn" data-translate-key="resume_reading" style="display: none; padding: 10px 15px; margin-top: 10px; background: var(--primary-color); color: var(--bg-color); border: none; border-radius: 5px; cursor: pointer; box-shadow: var(--neumorph-shadow-2);">Resume Reading</button>
                    [data-theme="dark"] #resume-reading-btn { color: #000; }
                </div>
            </div>
            <div id="page-surahs" class="page"> <ul class="surah-list" id="surah-list"></ul> </div>
            <div id="page-search" class="page">
                <div class="search-input-container">
                    <input type="text" id="search-input" class="search-input" placeholder="Search Arabic or Urdu..." data-translate-key="search_placeholder">
                    <ul id="search-suggestions"></ul>
                </div>
                <div id="search-results" class="ayah-list"></div>
                 <p id="search-no-results" style="display: none; text-align: center; opacity: 0.7;" data-translate-key="search_no_results">No results found.</p>
                 <p id="search-error" style="display: none; text-align: center; opacity: 0.7;" data-translate-key="search_error">Error during search.</p>
                 <p id="search-init" style="text-align: center; opacity: 0.7;" data-translate-key="search_init">Enter search term above.</p>
            </div>
            <div id="page-bookmarks" class="page">
                <h2 data-translate-key="bookmarks_title">Bookmarks</h2>
                <ul class="bookmark-list" id="bookmark-list"></ul>
                 <p id="no-bookmarks-msg" style="display: none; text-align: center; opacity: 0.7;" data-translate-key="bookmarks_empty">No bookmarks added yet.</p>
            </div>
            <div id="page-settings" class="page">
                <h2 data-translate-key="settings_title">Settings</h2>
                 <div class="settings-item">
                     <label data-translate-key="settings_ui_language">UI Language</label>
                     <div class="ui-language-toggle"> <button data-lang="en">EN</button> <button data-lang="ur">UR</button> </div>
                 </div>
                <div class="settings-item">
                    <label for="dark-mode-toggle" data-translate-key="settings_dark_mode">Dark Mode</label>
                    <label class="toggle-switch"> <input type="checkbox" id="dark-mode-toggle"> <span class="slider"></span> </label>
                </div>
                <div class="settings-item">
                    <label data-translate-key="settings_font_size">Font Size</label>
                    <div class="font-size-control"> <button data-size="small" data-translate-key="settings_font_small">S</button> <button data-size="medium" data-translate-key="settings_font_medium">M</button> <button data-size="large" data-translate-key="settings_font_large">L</button> </div>
                </div>
                 <div class="settings-item">
                    <label data-translate-key="settings_content_display">Content Display</label>
                    <div class="language-toggle"> <button data-display="arabic" data-translate-key="settings_display_arabic">Arabic</button> <button data-display="urdu" data-translate-key="settings_display_urdu">Urdu</button> <button data-display="both" data-translate-key="settings_display_both">Both</button> </div>
                </div>
                 <div class="settings-item">
                     <label data-translate-key="settings_reading_mode_type">Default Reading Mode</label>
                     <div class="reading-mode-type-toggle"> <button data-mode="ayah" data-translate-key="settings_mode_ayah">Ayah</button> <button data-mode="page" data-translate-key="settings_mode_page">Page</button> </div>
                 </div>
                 <div class="settings-item">
                     <label data-translate-key="settings_lines_per_page">Lines Per Page (Page Mode)</label>
                     <input type="number" id="lines-per-page-input" min="5" max="30" step="1">
                 </div>
                 <div class="settings-item">
                     <button id="clear-data-btn" style="color: #ff4d4d; background: none; border: 1px solid #ff4d4d; padding: 8px 12px; border-radius: 5px; cursor: pointer;" data-translate-key="settings_clear_data">Clear All Data & Reload</button>
                 </div>
            </div>
            <div id="page-ayahs" class="page"> <h2 id="ayah-view-surah-title"></h2> <div id="ayah-list" class="ayah-list"></div> </div>
        </main>
        <nav class="bottom-nav">
            <button class="nav-item active" data-page="home"> <svg viewBox="0 0 24 24"><path d="M10 20v-6h4v6h5v-8h3L12 3 2 12h3v8z"/></svg> <span data-translate-key="nav_home">Home</span> </button>
            <button class="nav-item" data-page="surahs"> <svg viewBox="0 0 24 24"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"/></svg> <span data-translate-key="nav_surahs">Surahs</span> </button>
            <button class="nav-item" data-page="search"> <svg viewBox="0 0 24 24"><path d="M15.5 14h-.79l-.28-.27a6.5 6.5 0 0 0 1.48-5.34c-.47-2.78-2.79-5-5.59-5.34a6.505 6.505 0 0 0-7.27 7.27c.34 2.8 2.56 5.12 5.34 5.59a6.5 6.5 0 0 0 5.34-1.48l.27.28v.79l5 4.99L20.49 19l-4.99-5zm-6 0C7.01 14 5 11.99 5 9.5S7.01 5 9.5 5 14 7.01 14 9.5 11.99 14 9.5 14z"/></svg> <span data-translate-key="nav_search">Search</span> </button>
            <button class="nav-item" data-page="bookmarks"> <svg viewBox="0 0 24 24"><path d="M17 3H7c-1.1 0-2 .9-2 2v16l7-3 7 3V5c0-1.1-.9-2-2-2z"/></svg> <span data-translate-key="nav_bookmarks">Bookmarks</span> </button>
            <button class="nav-item" data-page="settings"> <svg viewBox="0 0 24 24"><path d="M19.43 12.98c.04-.32.07-.64.07-.98s-.03-.66-.07-.98l2.11-1.65c.19-.15.24-.42.12-.64l-2-3.46c-.12-.22-.39-.3-.61-.22l-2.49 1c-.52-.4-1.08-.73-1.69-.98l-.38-2.65C14.46 2.18 14.25 2 14 2h-4c-.25 0-.46.18-.49.42l-.38 2.65c-.61.25-1.17.59-1.69.98l-2.49-1c-.23-.09-.49 0-.61.22l-2 3.46c-.13.22-.07.49.12.64l2.11 1.65c-.04.32-.07.65-.07.98s.03.66.07.98l-2.11 1.65c-.19.15-.24.42-.12.64l2 3.46c.12.22.39.3.61.22l2.49-1c.52.4 1.08.73 1.69.98l.38 2.65c.03.24.24.42.49.42h4c.25 0 .46-.18.49-.42l.38-2.65c.61-.25 1.17-.59 1.69-.98l2.49 1c.23.09.49 0 .61-.22l2-3.46c.12-.22.07-.49-.12-.64l-2.11-1.65zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z"/></svg> <span data-translate-key="nav_settings">Settings</span> </button>
        </nav>
    </div>
     <div class="reading-mode" id="reading-mode">
        <div class="reading-controls-top">
             <button id="fullscreen-btn" data-translate-key="fullscreen_toggle_title" title="Toggle Fullscreen">
                  <svg viewBox="0 0 24 24" width="24" height="24" fill="currentColor"><path d="M7 14H5v5h5v-2H7v-3zm-2-4h2V7h3V5H5v5zm12 7h-3v2h5v-5h-2v3zM14 5v2h3v3h2V5h-5z"/></svg>
              </button>
              <button id="reading-mode-close" data-translate-key="reading_mode_close_title" title="Close Reading Mode">&times;</button>
          </div>
        <div class="reading-nav-overlay reading-nav-prev" id="reading-nav-prev"></div>
        <div class="reading-nav-overlay reading-nav-next" id="reading-nav-next"></div>
        <div class="reading-content" id="reading-content"> <!-- Content populated by JS --> </div>
        <div class="swipe-indicator" data-translate-key="reading_swipe">&lt; Swipe &gt;</div>
    </div>
    <div class="loader-container" id="loader"> <div class="loader"></div> <p class="loader-text" id="loader-text" data-translate-key="loader_init">Initializing...</p> </div>

<script>
    const DB_NAME='quranDB',DB_VERSION=1,STORE_NAME='ayahs',SETTINGS_STORE_NAME='settings',SURAHS_COUNT=114,DATA_FILE_PATH='data/data.AM';
    const translations={en:{app_title:"Quran App",nav_home:"Home",nav_surahs:"Surahs",nav_search:"Search",nav_bookmarks:"Bookmarks",nav_settings:"Settings",home_welcome:"Welcome",home_start_journey:"Start your Quran journey.",home_progress:"Reading Progress",home_last_read:"Last Read",last_read_empty:"Not started yet.",resume_reading:"Resume Reading",surah_page_title:"Surahs",search_title:"Search",search_placeholder:"Search Arabic or Urdu...",search_no_results:"No results found.",search_error:"Error during search.",search_init:"Enter search term above.",bookmarks_title:"Bookmarks",bookmarks_empty:"No bookmarks added yet.",settings_title:"Settings",settings_ui_language:"UI Language",settings_dark_mode:"Dark Mode",settings_font_size:"Font Size",settings_font_small:"S",settings_font_medium:"M",settings_font_large:"L",settings_content_display:"Content Display",settings_display_arabic:"Arabic",settings_display_urdu:"Urdu",settings_display_both:"Both",settings_clear_data:"Clear All Data & Reload",settings_reading_mode_type:"Default Reading Mode",settings_mode_ayah:"Ayah",settings_mode_page:"Page",settings_lines_per_page:"Lines/Page",reading_swipe:"< Swipe >",loader_init:"Initializing...",loader_fetching:"Fetching data (first time)...",loader_populating:"Storing data (first time): {count}/{total}...",loader_loading:"Loading...",loader_clearing:"Clearing data...",loader_error:"Error initializing application. Please refresh.",data_fetch_error:"Error: Could not fetch Quran data file.",confirm_clear_data:"Are you sure you want to clear all Quran data, bookmarks, read status, and settings? This cannot be undone and will require reloading the app.",alert_clear_success:"Data cleared. The application will now reload.",alert_clear_error:"Error clearing data. You might need to clear browser data manually.",alert_clear_blocked:"Could not clear data because the database is still in use. Please close other instances of this app and reload, then try again.",error_generic:"An error occurred.",ayah:"Ayah",bookmark_toggle_title:"Toggle Bookmark",bookmark_add_title:"Add Bookmark",bookmark_remove_title:"Remove Bookmark",read_toggle_read_title:"Mark as Read",read_toggle_unread_title:"Mark as Unread",reading_mode_enter_title:"Enter Reading Mode",reading_mode_close_title:"Close Reading Mode",db_not_available:"Database not available.",db_access_error:"Error accessing database.",read_count:"{count}/{total} Read",fullscreen_toggle_title:"Toggle Fullscreen"},ur:{app_title:"قرآن ایپ",nav_home:"گھر",nav_surahs:"سورتیں",nav_search:"تلاش",nav_bookmarks:"بک مارکس",nav_settings:"ترتیبات",home_welcome:"خوش آمدید",home_start_journey:"اپنا قرآنی سفر شروع کریں۔",home_progress:"پڑھنے کی پیشرفت",home_last_read:"آخری پڑھا ہوا",last_read_empty:"ابھی تک شروع نہیں کیا گیا۔",resume_reading:"پڑھنا جاری رکھیں",surah_page_title:"سورتیں",search_title:"تلاش",search_placeholder:"عربی یا اردو میں تلاش کریں...",search_no_results:"کوئی نتیجہ نہیں ملا۔",search_error:"تلاش کے دوران خرابی۔",search_init:"اوپر تلاش کی اصطلاح درج کریں۔",bookmarks_title:"بک مارکس",bookmarks_empty:"ابھی تک کوئی بک مارک شامل نہیں کیا گیا۔",settings_title:"ترتیبات",settings_ui_language:"زبان",settings_dark_mode:"ڈارک موڈ",settings_font_size:"فونٹ سائز",settings_font_small:"چھوٹا",settings_font_medium:"درمیانہ",settings_font_large:"بڑا",settings_content_display:"مواد ڈسپلے",settings_display_arabic:"عربی",settings_display_urdu:"اردو",settings_display_both:"دونوں",settings_clear_data:"تمام ڈیٹا صاف کریں اور دوبارہ لوڈ کریں",settings_reading_mode_type:"ڈیفالٹ ریڈنگ موڈ",settings_mode_ayah:"آیت",settings_mode_page:"صفحہ",settings_lines_per_page:"لائنیں/صفحہ",reading_swipe:"< سوائپ کریں >",loader_init:"شروع کیا جا رہا ہے...",loader_fetching:"ڈیٹا حاصل کیا جا رہا ہے (پہلی بار)...",loader_populating:"ڈیٹا محفوظ کیا جا رہا ہے (پہلی بار): {count}/{total}...",loader_loading:"لوڈ ہو رہا ہے۔..",loader_clearing:"ڈیٹا صاف کیا جا رہا ہے۔..",loader_error:"ایپلی کیشن شروع کرنے میں خرابی۔ براہ کرم ریفریش کریں۔",data_fetch_error:"خرابی: قرآن ڈیٹا فائل حاصل نہیں کی جا سکی۔",confirm_clear_data:"کیا آپ واقعی تمام قرآن ڈیٹا، بک مارکس، پڑھنے کی حیثیت، اور ترتیبات کو صاف کرنا چاہتے ہیں؟ یہ عمل ناقابل واپسی ہے اور ایپ کو دوبارہ لوڈ کرنے کی ضرورت ہوگی۔",alert_clear_success:"ڈیٹا صاف ہو گیا۔ ایپلیکیشن اب دوبارہ لوڈ ہو گی۔",alert_clear_error:"ڈیٹا صاف کرنے میں خرابی۔ آپ کو براؤزر کا ڈیٹا دستی طور پر صاف کرنے کی ضرورت پڑسکتی ہے۔",alert_clear_blocked:"ڈیٹا صاف نہیں کیا جا سکا کیونکہ ڈیٹا بیس ابھی تک استعمال میں ہے۔ براہ کرم اس ایپ کی دوسری مثالیں بند کریں اور دوبارہ لوڈ کریں، پھر دوبارہ کوشش کریں۔",error_generic:"ایک خرابی پیش آگئی۔",ayah:"آیت",bookmark_toggle_title:"بک مارک ٹوگل کریں",bookmark_add_title:"بک مارک شامل کریں",bookmark_remove_title:"بک مارک ہٹائیں",read_toggle_read_title:"پڑھا ہوا نشان زد کریں",read_toggle_unread_title:"ناخواندہ نشان زد کریں",reading_mode_enter_title:"ریڈنگ موڈ میں داخل ہوں",reading_mode_close_title:"ریڈنگ موڈ بند کریں",db_not_available:"ڈیٹا بیس دستیاب نہیں ہے۔",db_access_error:"ڈیٹا بیس تک رسائی میں خرابی۔",read_count:"{count}/{total} پڑھے ہوئے",fullscreen_toggle_title:"فل سکرین ٹوگل کریں"}};
    const surahNames=["Al-Fatiha","Al-Baqarah","Aal-e-Imran","An-Nisa","Al-Ma'idah","Al-An'am","Al-A'raf","Al-Anfal","At-Tawbah","Yunus","Hud","Yusuf","Ar-Ra'd","Ibrahim","Al-Hijr","An-Nahl","Al-Isra","Al-Kahf","Maryam","Taha","Al-Anbiya","Al-Hajj","Al-Mu'minun","An-Nur","Al-Furqan","Ash-Shu'ara","An-Naml","Al-Qasas","Al-Ankabut","Ar-Rum","Luqman","As-Sajdah","Al-Ahzab","Saba","Fatir","Ya-Sin","As-Saffat","Sad","Az-Zumar","Ghafir","Fussilat","Ash-Shura","Az-Zukhruf","Ad-Dukhan","Al-Jathiyah","Al-Ahqaf","Muhammad","Al-Fath","Al-Hujurat","Qaf","Adh-Dhariyat","At-Tur","An-Najm","Al-Qamar","Ar-Rahman","Al-Waqi'ah","Al-Hadid","Al-Mujadila","Al-Hashr","Al-Mumtahanah","As-Saff","Al-Jumu'ah","Al-Munafiqun","At-Taghabun","At-Talaq","At-Tahrim","Al-Mulk","Al-Qalam","Al-Haqqah","Al-Ma'arij","Nuh","Al-Jinn","Al-Muzzammil","Al-Muddaththir","Al-Qiyamah","Al-Insan","Al-Mursalat","An-Naba","An-Nazi'at","'Abasa","At-Takwir","Al-Infitar","Al-Mutaffifin","Al-Inshiqaq","Al-Buruj","At-Tariq","Al-A'la","Al-Ghashiyah","Al-Fajr","Al-Balad","Ash-Shams","Al-Layl","Ad-Duha","Ash-Sharh","At-Tin","Al-'Alaq","Al-Qadr","Al-Bayyinah","Az-Zalzalah","Al-'Adiyat","Al-Qari'ah","At-Takathur","Al-'Asr","Al-Humazah","Al-Fil","Quraysh","Al-Ma'un","Al-Kawthar","Al-Kafirun","An-Nasr","Al-Masad","Al-Ikhlas","Al-Falaq","An-Nas"];
    let db,currentSurah=null,currentAyah=null,readingModeActive=false,readingModeCurrentId=null,touchStartX=0,touchEndX=0,searchDebounceTimer,currentPageFirstId=null,currentPageLastId=null;
    let currentSettings={theme:'light',fontSize:'medium',display:'both',language:'en',readingModeType:'ayah',linesPerPage:10};
    let lastRead={surah:null,ayah:null,id:null},actualTotalAyahs=0;

    const loader=document.getElementById('loader'),loaderText=document.getElementById('loader-text'),pages=document.querySelectorAll('.page'),navItems=document.querySelectorAll('.nav-item'),headerTitle=document.querySelector('.header-title'),surahListEl=document.getElementById('surah-list'),ayahListEl=document.getElementById('ayah-list'),ayahViewSurahTitle=document.getElementById('ayah-view-surah-title'),searchInput=document.getElementById('search-input'),searchSuggestionsEl=document.getElementById('search-suggestions'),searchResultsEl=document.getElementById('search-results'),searchNoResults=document.getElementById('search-no-results'),searchError=document.getElementById('search-error'),searchInit=document.getElementById('search-init'),bookmarkListEl=document.getElementById('bookmark-list'),noBookmarksMsg=document.getElementById('no-bookmarks-msg'),darkModeToggle=document.getElementById('dark-mode-toggle'),fontSizeControls=document.querySelector('.font-size-control'),languageToggleControls=document.querySelector('.language-toggle'),uiLanguageToggle=document.querySelector('.ui-language-toggle'),readingModeTypeToggle=document.querySelector('.reading-mode-type-toggle'),linesPerPageInput=document.getElementById('lines-per-page-input'),progressBarInner=document.getElementById('progress-bar-inner'),progressText=document.getElementById('progress-text'),lastReadInfo=document.getElementById('last-read-info'),resumeReadingBtn=document.getElementById('resume-reading-btn'),readingModeEl=document.getElementById('reading-mode'),readingContentEl=document.getElementById('reading-content'),readingModeCloseBtn=document.getElementById('reading-mode-close'),readingNavPrev=document.getElementById('reading-nav-prev'),readingNavNext=document.getElementById('reading-nav-next'),clearDataBtn=document.getElementById('clear-data-btn'),fullscreenBtn=document.getElementById('fullscreen-btn'),body=document.body;

    function t(k,r={}){let l=currentSettings.language||'en',t=translations[l]?.[k]||translations.en[k]||`[${k}]`;for(const p in r){t=t.replace(`{${p}}`,r[p]);}return t;}
    function updateUIText(){document.querySelectorAll('[data-translate-key]').forEach(el=>{const k=el.dataset.translateKey;const p=el.tagName==='INPUT'&&el.hasAttribute('placeholder');const i=el.hasAttribute('title');if(p){el.placeholder=t(k);}else if(i&&k){el.title=t(k);}else if(k){el.textContent=t(k);}});updateProgressText();updateLastReadText();body.lang=currentSettings.language;updateHeaderTitle();}
    function showLoader(k='loader_loading',r={}){loaderText.textContent=t(k,r);loader.style.display='flex';}
    function hideLoader(){loader.style.display='none';}
    function initDB(){return new Promise((res,rej)=>{const req=indexedDB.open(DB_NAME,DB_VERSION);req.onupgradeneeded=(e)=>{db=e.target.result;if(!db.objectStoreNames.contains(STORE_NAME)){const s=db.createObjectStore(STORE_NAME,{keyPath:'id',autoIncrement:true});s.createIndex('surah_ayah',['surah','ayah'],{unique:true});s.createIndex('surah','surah');s.createIndex('arabic','arabic');s.createIndex('urdu','urdu');s.createIndex('bookmarked','bookmarked');s.createIndex('read','read');}if(!db.objectStoreNames.contains(SETTINGS_STORE_NAME)){db.createObjectStore(SETTINGS_STORE_NAME,{keyPath:'key'});}};req.onsuccess=(e)=>{db=e.target.result;res(db);};req.onerror=(e)=>{console.error('DB error:',e.target.errorCode);rej(e.target.error);};});}
    function getSetting(k){return new Promise((res,rej)=>{if(!db)return rej("DB not init");if(!db.objectStoreNames.contains(SETTINGS_STORE_NAME))return res(undefined);try{const t=db.transaction(SETTINGS_STORE_NAME,'readonly'),s=t.objectStore(SETTINGS_STORE_NAME),r=s.get(k);r.onsuccess=()=>res(r.result?r.result.value:undefined);r.onerror=(e)=>rej(e.target.error);}catch(e){rej(`Tx error: ${e}`);}});}
    function setSetting(k,v){return new Promise((res,rej)=>{if(!db)return rej("DB not init");if(!db.objectStoreNames.contains(SETTINGS_STORE_NAME))return rej("Settings store not found");try{const t=db.transaction(SETTINGS_STORE_NAME,'readwrite'),s=t.objectStore(SETTINGS_STORE_NAME),r=s.put({key:k,value:v});r.onsuccess=()=>res();r.onerror=(e)=>rej(e.target.error);}catch(e){rej(`Tx error: ${e}`);}});}
    async function checkDBPopulated(){try{const f=await getSetting('db_populated');if(f){if(!db||!db.objectStoreNames.contains(STORE_NAME)){console.warn("Flag true, store missing");await setSetting('db_populated',false);return false;}return new Promise((res)=>{const t=db.transaction(STORE_NAME,'readonly'),s=t.objectStore(STORE_NAME),c=s.count();c.onsuccess=()=>{actualTotalAyahs=c.result;if(actualTotalAyahs>0){console.log(`DB verified: ${actualTotalAyahs}`);res(true);}else{console.warn("Flag true, count 0");setSetting('db_populated',false).finally(()=>res(false));}};c.onerror=(e)=>{console.error('Verify count error:',e.target.error);res(false);}});}}catch(e){console.error("Error check populated:",e);return false;}return false;}
    function fetchAndPopulateDB(){return new Promise(async(res,rej)=>{showLoader('loader_fetching');try{const resp=await fetch(DATA_FILE_PATH);if(!resp.ok)throw new Error(`HTTP error! status: ${resp.status}`);const data=await resp.text();showLoader('loader_populating',{count:0,total:'?'});const lines=data.trim().split('\n'),regex=/(.+?)\s+ترجمہ:\s+(.+?)<br\/>س\s+(\d+)\s+آ\s+(\d+)/;let count=0,expectedTotal=0;lines.forEach(l=>{if(l.trim().match(regex))expectedTotal++;});showLoader('loader_populating',{count:0,total:expectedTotal});const tx=db.transaction(STORE_NAME,'readwrite'),st=tx.objectStore(STORE_NAME);let errors=0;tx.oncomplete=()=>{console.log(`DB populated. Added: ${count}, Errors: ${errors}`);actualTotalAyahs=count;setSetting('db_populated',true).then(updateProgress).finally(res);};tx.onerror=(e)=>{console.error('Tx error populate:',e.target.error);hideLoader();rej(`Tx error: ${e.target.error.message||e.target.error}`);};tx.onabort=(e)=>{console.error('Tx abort populate:',e.target.error);hideLoader();rej(`Tx abort: ${e.target.error?e.target.error.name+' - '+e.target.error.message:'Unknown'}`);};for(let i=0;i<lines.length;i++){const l=lines[i].trim();if(!l)continue;const m=l.match(regex);if(m){const[,ar,ur,su,ay]=m;const d={surah:parseInt(su),ayah:parseInt(ay),arabic:ar.trim(),urdu:ur.trim(),bookmarked:0,read:0};const req=st.add(d);req.onsuccess=()=>{count++;if(count%100===0||count===expectedTotal){setTimeout(()=>showLoader('loader_populating',{count:count,total:expectedTotal}),0);}};req.onerror=(e)=>{errors++;if(e.target.error.name!=='ConstraintError'){console.error('Error adding:',e.target.error.message,`S${su} A${ay}`);}e.preventDefault();};}else{console.warn('No parse:',l);}}}catch(e){console.error('Fetch/Parse error:',e);hideLoader();alert(t('data_fetch_error')+` (${e.message})`);rej(e);}}); }
    function updateHeaderTitle(){const ap=document.querySelector('.page.active');let tk='app_title';if(ap){const pid=ap.id.replace('page-','');switch(pid){case 'home':tk='app_title';break;case 'surahs':tk='surah_page_title';break;case 'search':tk='search_title';break;case 'bookmarks':tk='bookmarks_title';break;case 'settings':tk='settings_title';break;case 'ayahs':if(currentSurah!==null){headerTitle.textContent=`Surah ${surahNames[currentSurah-1]||currentSurah} (${currentSurah})`;return;}break;}}headerTitle.textContent=t(tk);}
    function navigateToPage(pid){pages.forEach(p=>p.classList.remove('active'));const tp=document.getElementById(`page-${pid}`);if(tp)tp.classList.add('active');navItems.forEach(i=>i.classList.remove('active'));const ani=document.querySelector(`.nav-item[data-page="${pid}"]`);if(ani)ani.classList.add('active');updateHeaderTitle();if(pid==='surahs')loadSurahList();if(pid==='bookmarks')loadBookmarks();if(pid==='home'){updateProgress();loadLastReadInfo();}if(pid==='search'){searchInput.value='';searchResultsEl.innerHTML='';searchSuggestionsEl.innerHTML='';searchSuggestionsEl.style.display='none';searchNoResults.style.display='none';searchError.style.display='none';searchInit.style.display='block';}if(pid!=='ayahs'){const mc=document.querySelector('.main-content');if(mc)mc.scrollTop=0;}}
    function loadSurahList(){surahListEl.innerHTML='';const f=document.createDocumentFragment();for(let i=1;i<=SURAHS_COUNT;i++){const li=document.createElement('li');li.className='list-item surah-item';li.dataset.surah=i;li.innerHTML=`<div class="surah-info"><span class="surah-number">${i}</span> <span class="surah-name">${surahNames[i-1]||`Surah ${i}`}</span></div><span class="surah-details">➔</span>`;li.addEventListener('click',()=>loadAyahView(i));f.appendChild(li);}surahListEl.appendChild(f);}
    function loadAyahView(sn){currentSurah=sn;headerTitle.textContent=`Surah ${surahNames[sn-1]||sn} (${sn})`;ayahViewSurahTitle.textContent=`Surah ${surahNames[sn-1]||sn} (${sn})`;navigateToPage('ayahs');showLoader('loader_loading');ayahListEl.innerHTML='';if(!db){hideLoader();ayahListEl.innerHTML='<p>DB N/A</p>';return;}try{const tx=db.transaction(STORE_NAME,'readonly'),st=tx.objectStore(STORE_NAME),idx=st.index('surah'),req=idx.getAll(sn);req.onsuccess=()=>{const ayahs=req.result.sort((a,b)=>a.ayah-b.ayah);renderAyahs(ayahs,ayahListEl);hideLoader();const mc=document.querySelector('.main-content'),sp=sessionStorage.getItem(`scroll_surah_${sn}`);if(sp&&!lastRead.id){mc.scrollTop=parseInt(sp,10);}else{mc.scrollTop=0;}if(lastRead.surah===sn&&lastRead.id!==null){const lre=ayahListEl.querySelector(`[data-id="${lastRead.id}"]`);if(lre){setTimeout(()=>{lre.scrollIntoView({behavior:'smooth',block:'center'});},150);}}};req.onerror=(e)=>{console.error('Fetch ayahs error:',e.target.error);hideLoader();ayahListEl.innerHTML='<p>Error loading.</p>';};}catch(e){console.error("Tx error load ayahs:",e);hideLoader();ayahListEl.innerHTML='<p>DB access error.</p>';}}
    function renderAyahs(ayahs,cont,st=null){cont.innerHTML='';const f=document.createDocumentFragment();ayahs.forEach(a=>{const li=document.createElement('li');li.className='ayah-item';li.dataset.id=a.id;li.dataset.surah=a.surah;li.dataset.ayah=a.ayah;if(a.read)li.classList.add('read');let ar=a.arabic||'',ur=a.urdu||'';if(st){try{const esc=st.replace(/[.*+?^${}()|[\]\\]/g,'\\$&'),rgx=new RegExp(`(${esc})`,'gi');ar=ar.replace(rgx,'<mark>$1</mark>');ur=ur.replace(rgx,'<mark>$1</mark>');}catch(e){console.warn("Regex highlight error:",e);}}li.innerHTML=`<div class="ayah-header"><span>${a.surah}:${a.ayah}</span><div class="ayah-controls"><button class="bookmark-btn ${a.bookmarked?'active':''}"><svg viewBox="0 0 24 24"><path d="M17 3H7c-1.1 0-2 .9-2 2v16l7-3 7 3V5c0-1.1-.9-2-2-2zm0 15l-5-2.18L7 18V5h10v13z"/></svg></button><button class="read-toggle-btn ${a.read?'active':''}"><svg viewBox="0 0 24 24"><path d="M9 16.17 4.83 12l-1.42 1.41L9 19 21 7l-1.41-1.41z"/></svg></button><button class="read-mode-btn"><svg viewBox="0 0 24 24"><path d="M19 19H5V5h7V3H5c-1.11 0-2 .9-2 2v14c0 1.1.9 2 2 2h14c1.1 0 2-.9 2-2v-7h-2v7zM14 3v2h3.59l-9.83 9.83 1.41 1.41L19 6.41V10h2V3h-7z"/></svg></button></div></div><p class="ayah-text-arabic" dir="rtl">${ar}</p><p class="ayah-text-urdu" dir="rtl">${ur}</p>`;const bb=li.querySelector('.bookmark-btn'),rb=li.querySelector('.read-toggle-btn'),rmb=li.querySelector('.read-mode-btn');bb.title=t(a.bookmarked?'bookmark_remove_title':'bookmark_add_title');rb.title=t(a.read?'read_toggle_unread_title':'read_toggle_read_title');rmb.title=t('reading_mode_enter_title');if(bb)bb.addEventListener('click',(e)=>{e.stopPropagation();toggleBookmark(a.id,bb);});if(rb)rb.addEventListener('click',(e)=>{e.stopPropagation();toggleReadStatus(a.id,li);saveLastReadPosition(a.surah,a.ayah,a.id);});if(rmb)rmb.addEventListener('click',(e)=>{e.stopPropagation();enterReadingMode(a.id);});li.addEventListener('click',()=>{saveLastReadPosition(a.surah,a.ayah,a.id);});f.appendChild(li);});cont.appendChild(f);}
    function updateAyahUI(id,upd){document.querySelectorAll(`.ayah-item[data-id="${id}"]`).forEach(el=>{updateSingleAyahItemUI(el,upd);if(upd.hasOwnProperty('bookmarked')&&!upd.bookmarked&&el.closest('#bookmark-list')){el.remove();if(bookmarkListEl.children.length===0){noBookmarksMsg.style.display='block';}}});}
    function updateSingleAyahItemUI(el,upd){if(upd.hasOwnProperty('bookmarked')){const b=el.querySelector('.bookmark-btn');if(b){const ib=!!upd.bookmarked;b.classList.toggle('active',ib);b.title=t(ib?'bookmark_remove_title':'bookmark_add_title');}}if(upd.hasOwnProperty('read')){const b=el.querySelector('.read-toggle-btn');const ir=!!upd.read;el.classList.toggle('read',ir);if(b){b.classList.toggle('active',ir);b.title=t(ir?'read_toggle_unread_title':'read_toggle_read_title');}}}
    function updateAyahData(id,upd){return new Promise((res,rej)=>{if(!db)return rej("DB not init");try{const tx=db.transaction(STORE_NAME,'readwrite'),st=tx.objectStore(STORE_NAME),r1=st.get(id);r1.onsuccess=()=>{const d=r1.result;if(!d)return rej("Ayah not found");Object.assign(d,upd);const r2=st.put(d);r2.onsuccess=()=>{updateAyahUI(id,upd);res();};r2.onerror=(e)=>rej(e.target.error);};r1.onerror=(e)=>rej(e.target.error);tx.onerror=(e)=>{console.error("Tx error updAyahData:",e.target.error);rej(e.target.error);};}catch(e){rej(`Tx error create upd: ${e}`);}});}
    async function toggleBookmark(id,btn){const ia=btn.classList.contains('active');try{await updateAyahData(id,{bookmarked:ia?0:1});}catch(e){console.error('Fail toggle bookmark:',e);}}
    async function toggleReadStatus(id,li){const ir=li.classList.contains('read');try{await updateAyahData(id,{read:ir?0:1});updateProgress();}catch(e){console.error('Fail toggle read:',e);}}
    function updateProgressText(){const rc=parseInt(progressBarInner.dataset.readCount||'0'),tot=actualTotalAyahs||0,pct=tot>0?Math.round((rc/tot)*100):0;progressText.textContent=`${pct}% (${t('read_count',{count:rc,total:tot})})`;}
    function updateProgress(){if(!db||!db.objectStoreNames.contains(STORE_NAME)){progressBarInner.style.width=`0%`;progressBarInner.dataset.readCount=0;updateProgressText();return;}try{const tx=db.transaction(STORE_NAME,'readonly'),st=tx.objectStore(STORE_NAME),ri=st.index('read'),rcr=ri.count(1);rcr.onsuccess=()=>{const rc=rcr.result;progressBarInner.dataset.readCount=rc;const tcr=st.count();tcr.onsuccess=()=>{actualTotalAyahs=tcr.result;const pct=actualTotalAyahs>0?Math.round((rc/actualTotalAyahs)*100):0;progressBarInner.style.width=`${pct}%`;updateProgressText();console.log(`Prog upd: ${pct}%`);};tcr.onerror=(e)=>{console.error('Error total count prog:',e.target.error);updateProgressText();};};rcr.onerror=(e)=>{console.error('Error count read:',e.target.error);};}catch(e){console.error("Tx error progress:",e);}}
    function performSearch(q){searchResultsEl.innerHTML='';searchInit.style.display='none';searchNoResults.style.display='none';searchError.style.display='none';searchSuggestionsEl.style.display='none';searchSuggestionsEl.innerHTML='';if(!q||q.length<2){searchInit.style.display='block';return;}searchResultsEl.innerHTML=`<p>${t('loader_loading')}</p>`;if(!db||!db.objectStoreNames.contains(STORE_NAME)){searchResultsEl.innerHTML='';searchError.textContent=t('db_not_available');searchError.style.display='block';return;}try{const tx=db.transaction(STORE_NAME,'readonly'),st=tx.objectStore(STORE_NAME),res=[],lq=q.toLowerCase();let cur=st.openCursor();const MAX=100;cur.onsuccess=(e)=>{const c=e.target.result;if(c&&res.length<MAX){const a=c.value;let m=false;if(a.arabic&&a.arabic.includes(q))m=true;else if(a.urdu&&a.urdu.toLowerCase().includes(lq))m=true;if(m)res.push(a);c.continue();}else{renderSearchResults(res,q);}};cur.onerror=(e)=>{console.error('Search error:',e.target.error);searchResultsEl.innerHTML='';searchError.textContent=t('search_error');searchError.style.display='block';};}catch(e){console.error("Tx error search:",e);searchResultsEl.innerHTML='';searchError.textContent=t('db_access_error');searchError.style.display='block';}}
    function performSuggestionSearch(q){searchSuggestionsEl.innerHTML='';searchSuggestionsEl.style.display='none';if(!q||q.length<2||!db||!db.objectStoreNames.contains(STORE_NAME))return;try{const tx=db.transaction(STORE_NAME,'readonly'),st=tx.objectStore(STORE_NAME),sugs=[],ids=new Set(),lq=q.toLowerCase(),MAX=10;let ari=st.index('arabic'),uri=st.index('urdu'),arc=ari.openCursor(),urc=uri.openCursor();const proc=(c,fn)=>{if(c&&sugs.length<MAX){const a=c.value,txt=a[fn];if(!txt)return;const mi=fn==='urdu'?txt.toLowerCase().indexOf(lq):txt.indexOf(q);if(mi>-1&&!ids.has(a.id)){const sl=50;let s=Math.max(0,mi-Math.floor(sl/3)),e=Math.min(txt.length,mi+q.length+Math.ceil(sl*2/3)),sn=(s>0?'...':'')+txt.substring(s,e)+(e<txt.length?'...':'');try{const es=q.replace(/[.*+?^${}()|[\]\\]/g,'\\$&');sn=sn.replace(new RegExp(`(${es})`,'gi'),'<mark>$1</mark>');}catch(e){}sugs.push({text:sn,ayah:a});ids.add(a.id);}c.continue();}};let ad=false,ud=false;const chk=()=>{if(ad&&ud)renderSuggestions(sugs,q);};arc.onsuccess=(e)=>{proc(e.target.result,'arabic');if(!e.target.result){ad=true;chk();}};urc.onsuccess=(e)=>{proc(e.target.result,'urdu');if(!e.target.result){ud=true;chk();}};arc.onerror=urc.onerror=(e)=>{console.error('Sug cursor err:',e.target.error);if(e.target===arc)ad=true;else ud=true;chk();};}catch(e){console.error("Tx error sug:",e);}}
    function renderSuggestions(sugs,q){searchSuggestionsEl.innerHTML='';const uniq=Array.from(new Map(sugs.map(s=>[s.ayah.id,s])).values());if(uniq.length>0){uniq.slice(0,10).forEach(s=>{const li=document.createElement('li');li.innerHTML=`(${s.ayah.surah}:${s.ayah.ayah}) ${s.text}`;li.addEventListener('click',()=>{searchInput.value=q;performSearch(q);});searchSuggestionsEl.appendChild(li);});searchSuggestionsEl.style.display='block';}else{searchSuggestionsEl.style.display='none';}}
    function renderSearchResults(res,q){searchResultsEl.innerHTML='';if(res.length>0){searchInit.style.display='none';searchNoResults.style.display='none';searchError.style.display='none';renderAyahs(res,searchResultsEl,q);}else{searchInit.style.display='none';searchError.style.display='none';searchNoResults.textContent=t('search_no_results');searchNoResults.style.display='block';}}
    function loadBookmarks(){showLoader('loader_loading');bookmarkListEl.innerHTML='';noBookmarksMsg.style.display='none';if(!db||!db.objectStoreNames.contains(STORE_NAME)){hideLoader();noBookmarksMsg.textContent=t('db_not_available');noBookmarksMsg.style.display='block';return;}try{const tx=db.transaction(STORE_NAME,'readonly'),st=tx.objectStore(STORE_NAME),idx=st.index('bookmarked'),req=idx.getAll(1);req.onsuccess=()=>{const bms=req.result.sort((a,b)=>a.surah===b.surah?a.ayah-b.ayah:a.surah-b.surah);if(bms.length>0){renderAyahs(bms,bookmarkListEl);noBookmarksMsg.style.display='none';}else{noBookmarksMsg.textContent=t('bookmarks_empty');noBookmarksMsg.style.display='block';}hideLoader();};req.onerror=(e)=>{console.error('Err fetch bookmarks:',e.target.error);bookmarkListEl.innerHTML=`<p>${t('error_generic')}</p>`;noBookmarksMsg.style.display='none';hideLoader();};}catch(e){console.error("Tx err bookmarks:",e);hideLoader();bookmarkListEl.innerHTML=`<p>${t('db_access_error')}</p>`;noBookmarksMsg.style.display='none';}}
    function updateLastReadText(){if(lastRead.surah&&lastRead.ayah&&lastRead.id!==null){lastReadInfo.textContent=`Surah ${surahNames[lastRead.surah-1]||lastRead.surah} (${lastRead.surah}), ${t('ayah')} ${lastRead.ayah}`;resumeReadingBtn.style.display='inline-block';}else{lastReadInfo.textContent=t('last_read_empty');resumeReadingBtn.style.display='none';}}
    function applySettings(s,ut=true){body.dataset.theme=s.theme;darkModeToggle.checked=s.theme==='dark';body.dataset.fontSize=s.fontSize;fontSizeControls.querySelectorAll('button').forEach(b=>b.classList.toggle('active',b.dataset.size===s.fontSize));body.dataset.display=s.display;languageToggleControls.querySelectorAll('button').forEach(b=>b.classList.toggle('active',b.dataset.display===s.display));body.lang=s.language;uiLanguageToggle.querySelectorAll('button').forEach(b=>b.classList.toggle('active',b.dataset.lang===s.language));readingModeTypeToggle.querySelectorAll('button').forEach(b=>b.classList.toggle('active',b.dataset.mode===s.readingModeType));linesPerPageInput.value=s.linesPerPage;if(readingModeActive){const showAr=(s.display==='arabic'||s.display==='both'),showUr=(s.display==='urdu'||s.display==='both');document.querySelectorAll('.reading-mode .reading-ayah-arabic').forEach(el=>el.style.display=showAr?'block':'none');document.querySelectorAll('.reading-mode .reading-ayah-urdu').forEach(el=>el.style.display=showUr?'block':'none');}if(ut)updateUIText();}
    async function loadAndApplySettings(){try{const[th,fs,di,la,rmt,lpp]=await Promise.all([getSetting('theme'),getSetting('fontSize'),getSetting('display'),getSetting('language'),getSetting('readingModeType'),getSetting('linesPerPage')]);currentSettings.theme=th||'light';currentSettings.fontSize=fs||'medium';currentSettings.display=di||'both';currentSettings.language=la||'en';currentSettings.readingModeType=rmt||'ayah';currentSettings.linesPerPage=lpp||10;applySettings(currentSettings,true);console.log("Settings loaded:",currentSettings);}catch(e){console.error("Fail load settings:",e);applySettings(currentSettings,true);}}
    async function saveSettings(){try{await Promise.all([setSetting('theme',currentSettings.theme),setSetting('fontSize',currentSettings.fontSize),setSetting('display',currentSettings.display),setSetting('language',currentSettings.language),setSetting('readingModeType',currentSettings.readingModeType),setSetting('linesPerPage',currentSettings.linesPerPage)]);console.log("Settings saved:",currentSettings);}catch(e){console.error("Fail save settings:",e);}}
    function saveLastReadPosition(su,ay,id){if(id===null||id===undefined)return;lastRead={surah:su,ayah:ay,id:id};setSetting('lastRead',lastRead).then(()=>{console.log(`Last read saved: S${su}, A${ay}, ID ${id}`);updateLastReadText();}).catch(e=>console.error('Fail save last read:',e));}
    async function loadLastReadInfo(){try{const slr=await getSetting('lastRead');if(slr&&slr.surah&&slr.ayah&&slr.id!==undefined&&slr.id!==null){lastRead=slr;}else{lastRead={surah:null,ayah:null,id:null};}}catch(e){console.error('Fail load last read:',e);lastRead={surah:null,ayah:null,id:null};}updateLastReadText();}
    function getAyahById(id){return new Promise((res,rej)=>{if(!db)return rej("DB not init");if(id===null||id===undefined)return rej("Invalid ID");try{const tx=db.transaction(STORE_NAME,'readonly'),st=tx.objectStore(STORE_NAME),req=st.get(id);req.onsuccess=()=>res(req.result);req.onerror=(e)=>rej(e.target.error);}catch(e){rej(`Tx error getAyahById: ${e}`);}});}
    function getAdjacentAyahId(cid,dir){return new Promise(async(res,rej)=>{if(!db||cid===null||cid===undefined)return rej("DB/ID invalid");try{const ca=await getAyahById(cid);if(!ca)return rej("Current Ayah data not found: "+cid);const tx=db.transaction(STORE_NAME,'readonly'),st=tx.objectStore(STORE_NAME),idx=st.index('surah_ayah');let rng,cdir;if(dir==='next'){rng=IDBKeyRange.lowerBound([ca.surah,ca.ayah],true);cdir='next';}else{rng=IDBKeyRange.upperBound([ca.surah,ca.ayah],true);cdir='prev';}const req=idx.openCursor(rng,cdir);let f=false;req.onsuccess=(e)=>{const c=e.target.result;if(c){if(c.value.id===cid){c.continue();return;}res(c.value.id);f=true;}else if(!f){res(null);}};req.onerror=(e)=>rej(e.target.error);}catch(e){rej(`Error getAdjacent: ${e}`);}});}
    async function enterReadingMode(ayahId){if(ayahId===null||ayahId===undefined)return;if(currentSettings.readingModeType==='page'){await enterPageReadingMode(ayahId);}else{await enterAyahReadingMode(ayahId);}}
    async function enterAyahReadingMode(ayahId){try{const a=await getAyahById(ayahId);if(!a){console.error("Ayah data N/F:",ayahId);return;}readingModeCurrentId=a.id;currentPageFirstId=a.id;currentPageLastId=a.id;readingContentEl.innerHTML=`<p class="reading-ayah-arabic" dir="rtl">${a.arabic||''}</p><p class="reading-ayah-urdu" dir="rtl">${a.urdu||''}</p>`;readingModeEl.classList.remove('mode-page');readingModeEl.classList.add('mode-ayah');applySettings(currentSettings,false);readingModeEl.style.display='flex';readingModeActive=true;body.style.overflow='hidden';if(!a.read){await updateAyahData(a.id,{read:1});updateProgress();}saveLastReadPosition(a.surah,a.ayah,a.id);}catch(e){console.error("Error entering ayah mode:",e);}}
    async function enterPageReadingMode(startAyahId){try{const startAyah=await getAyahById(startAyahId);if(!startAyah){console.error("Start Ayah N/F:",startAyahId);return;}readingModeCurrentId=startAyahId;currentPageFirstId=startAyahId;showLoader('loader_loading');const ayahsOnPage=[startAyah];let currentId=startAyahId;const linesToFetch=currentSettings.linesPerPage-1;for(let i=0;i<linesToFetch;i++){const nextId=await getAdjacentAyahId(currentId,'next');if(nextId===null)break;const nextAyah=await getAyahById(nextId);if(nextAyah){ayahsOnPage.push(nextAyah);currentId=nextId;}else{break;}}currentPageLastId=currentId;renderAyahsForPageMode(ayahsOnPage,readingContentEl);readingModeEl.classList.remove('mode-ayah');readingModeEl.classList.add('mode-page');applySettings(currentSettings,false);readingModeEl.style.display='flex';readingModeActive=true;body.style.overflow='hidden';if(!startAyah.read){await updateAyahData(startAyah.id,{read:1});updateProgress();}saveLastReadPosition(startAyah.surah,startAyah.ayah,startAyah.id);readingContentEl.scrollTop=0;hideLoader();}catch(e){console.error("Error entering page mode:",e);hideLoader();}}
    function renderAyahsForPageMode(ayahs,cont){cont.innerHTML='';const frag=document.createDocumentFragment();const showAr=(currentSettings.display==='arabic'||currentSettings.display==='both'),showUr=(currentSettings.display==='urdu'||currentSettings.display==='both');ayahs.forEach(a=>{const div=document.createElement('div');div.className='reading-ayah-item';div.dataset.id=a.id;div.innerHTML=`<p class="reading-ayah-ref">${a.surah}:${a.ayah}</p>${showAr?`<p class="reading-ayah-arabic" dir="rtl">${a.arabic||''}</p>`:''}${showUr?`<p class="reading-ayah-urdu" dir="rtl">${a.urdu||''}</p>`:''}`;frag.appendChild(div);});cont.appendChild(frag);}
    function exitReadingMode(){readingModeEl.style.display='none';readingModeActive=false;readingModeCurrentId=null;currentPageFirstId=null;currentPageLastId=null;body.style.overflow='';if(lastRead.id!==null){updateAyahUI(lastRead.id,{read:1});}if(document.fullscreenElement){toggleFullScreen(false);}} // Exit fullscreen if active
    async function navigateReadingMode(dir){if(!readingModeCurrentId)return;showLoader("loader_loading");try{if(readingModeEl.classList.contains('mode-page')){await navigatePageMode(dir);}else{await navigateAyahMode(dir);}}catch(e){console.error(`Error navigating ${dir}:`,e);}finally{hideLoader();}}
    async function navigateAyahMode(dir){const adjId=await getAdjacentAyahId(readingModeCurrentId,dir);if(adjId!==null)await enterAyahReadingMode(adjId);else console.log(`Reached ${dir} end.`);}
    async function navigatePageMode(dir){if(dir==='next'){if(currentPageLastId===null)return;const nextPageStartId=await getAdjacentAyahId(currentPageLastId,'next');if(nextPageStartId!==null)await enterPageReadingMode(nextPageStartId);else console.log("Reached end.");}else{if(currentPageFirstId===null)return;let targetStartId=null;const idsToFind=currentSettings.linesPerPage;let currentCheckId=currentPageFirstId;let foundIds=[];for(let i=0;i<idsToFind;i++){const prevId=await getAdjacentAyahId(currentCheckId,'prev');if(prevId===null){targetStartId=(foundIds.length>0?foundIds[foundIds.length-1]:currentPageFirstId);break;}foundIds.push(prevId);currentCheckId=prevId;if(i===idsToFind-1){targetStartId=prevId;}}if(targetStartId!==null)await enterPageReadingMode(targetStartId);else console.log("Reached beginning.");}}
    function handleTouchStart(e){if(!readingModeActive)return;touchStartX=e.changedTouches[0].screenX;}
    function handleTouchEnd(e){if(!readingModeActive||touchStartX===0)return;touchEndX=e.changedTouches[0].screenX;handleSwipeGesture();touchStartX=touchEndX=0;}
    function handleSwipeGesture(){const t=50,dX=touchEndX-touchStartX;if(dX<-t)navigateReadingMode('next');else if(dX>t)navigateReadingMode('prev');}
    function toggleFullScreen(forceState=null){const el=document.documentElement;const isCurrentlyFullscreen=(document.fullscreenElement||document.webkitFullscreenElement||document.msFullscreenElement);const shouldEnter=(forceState===true||(forceState===null&&!isCurrentlyFullscreen));const shouldExit=(forceState===false||(forceState===null&&isCurrentlyFullscreen));if(shouldEnter){if(el.requestFullscreen){el.requestFullscreen().catch(err=>console.error(`FS Error: ${err.message}`));}else if(el.webkitRequestFullscreen){el.webkitRequestFullscreen();}else if(el.msRequestFullscreen){el.msRequestFullscreen();}}else if(shouldExit){if(document.exitFullscreen){document.exitFullscreen().catch(err=>console.error(`FS Exit Error: ${err.message}`));}else if(document.webkitExitFullscreen){document.webkitExitFullscreen();}else if(document.msExitFullscreen){document.msExitFullscreen();}}}

    document.addEventListener('DOMContentLoaded',async()=>{showLoader('loader_init');try{await initDB();await loadAndApplySettings();const pop=await checkDBPopulated();if(!pop){try{await fetchAndPopulateDB();}catch(e){console.error("Crit pop error:",e);showLoader('loader_error');return;}}else{console.log("DB populated.");updateProgress();await loadLastReadInfo();}navigateToPage('home');hideLoader();const mc=document.querySelector('.main-content');if(mc){mc.addEventListener('scroll',(e)=>{if(currentSurah!==null&&document.getElementById('page-ayahs').classList.contains('active')){sessionStorage.setItem(`scroll_surah_${currentSurah}`,e.target.scrollTop);}},{passive:true});}}catch(e){console.error('Init failed:',e);showLoader('loader_error');}});
    navItems.forEach(i=>i.addEventListener('click',()=>navigateToPage(i.dataset.page)));
    darkModeToggle.addEventListener('change',()=>{currentSettings.theme=darkModeToggle.checked?'dark':'light';applySettings(currentSettings,false);saveSettings();});
    fontSizeControls.addEventListener('click',(e)=>{if(e.target.tagName==='BUTTON'&&e.target.dataset.size){currentSettings.fontSize=e.target.dataset.size;applySettings(currentSettings,true);saveSettings();}}); // Update text for font size change potential
    languageToggleControls.addEventListener('click',(e)=>{if(e.target.tagName==='BUTTON'&&e.target.dataset.display){currentSettings.display=e.target.dataset.display;applySettings(currentSettings,false);saveSettings();}});
    uiLanguageToggle.addEventListener('click',(e)=>{if(e.target.tagName==='BUTTON'&&e.target.dataset.lang){currentSettings.language=e.target.dataset.lang;applySettings(currentSettings,true);saveSettings();}});
    readingModeTypeToggle.addEventListener('click',(e)=>{if(e.target.tagName==='BUTTON'&&e.target.dataset.mode){currentSettings.readingModeType=e.target.dataset.mode;applySettings(currentSettings,false);saveSettings();}});
    linesPerPageInput.addEventListener('change',()=>{const val=parseInt(linesPerPageInput.value);if(val>=5&&val<=30){currentSettings.linesPerPage=val;applySettings(currentSettings,false);saveSettings();}else{linesPerPageInput.value=currentSettings.linesPerPage;}});
    searchInput.addEventListener('input',()=>{clearTimeout(searchDebounceTimer);const q=searchInput.value.trim();searchResultsEl.innerHTML='';searchInit.style.display=q.length<2?'block':'none';searchNoResults.style.display='none';searchError.style.display='none';searchDebounceTimer=setTimeout(()=>performSuggestionSearch(q),350);});
    searchInput.addEventListener('keypress',(e)=>{if(e.key==='Enter'){e.preventDefault();clearTimeout(searchDebounceTimer);performSearch(searchInput.value.trim());}});
    searchInput.addEventListener('blur',()=>{setTimeout(()=>{if(!searchSuggestionsEl.contains(document.activeElement)){searchSuggestionsEl.style.display='none';}},200);});
    searchSuggestionsEl.addEventListener('mousedown',(e)=>{e.preventDefault();});
    readingModeCloseBtn.addEventListener('click',exitReadingMode);
    fullscreenBtn.addEventListener('click',()=>toggleFullScreen());
    readingNavPrev.addEventListener('click',()=>navigateReadingMode('prev'));
    readingNavNext.addEventListener('click',()=>navigateReadingMode('next'));
    readingModeEl.addEventListener('touchstart',handleTouchStart,{passive:true});
    readingModeEl.addEventListener('touchend',handleTouchEnd,false);
    resumeReadingBtn.addEventListener('click',()=>{if(lastRead.id!==null)enterReadingMode(lastRead.id);else if(lastRead.surah)loadAyahView(lastRead.surah);});
    clearDataBtn.addEventListener('click',async()=>{if(confirm(t('confirm_clear_data'))){try{showLoader('loader_clearing');if(db){db.close();db=null;}const dr=indexedDB.deleteDatabase(DB_NAME);dr.onsuccess=()=>{console.log('DB deleted');sessionStorage.clear();localStorage.clear();alert(t('alert_clear_success'));window.location.reload();};dr.onerror=(e)=>{console.error('Err deleting DB:',e.target.error);alert(t('alert_clear_error'));hideLoader();};dr.onblocked=()=>{console.warn('DB delete blocked');alert(t('alert_clear_blocked'));hideLoader();};}catch(e){console.error('Err clearing data:',e);alert(t('error_generic'));hideLoader();}}});

</script>

</body>
</html>
