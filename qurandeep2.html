<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Quran App</title>
    <style>
        :root {
            --primary: #2c3e50;
            --secondary: #34495e;
            --accent: #3498db;
            --text: #ecf0f1;
            --text-secondary: #bdc3c7;
            --background: #1a1a1a;
            --card: #2c3e50;
            --success: #27ae60;
            --warning: #f39c12;
            --danger: #e74c3c;
        }

        [data-theme="light"] {
            --primary: #3498db;
            --secondary: #2980b9;
            --accent: #e74c3c;
            --text: #2c3e50;
            --text-secondary: #7f8c8d;
            --background: #f5f5f5;
            --card: #ffffff;
            --success: #2ecc71;
            --warning: #f39c12;
            --danger: #e74c3c;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            transition: background-color 0.3s, color 0.3s;
        }

        body {
            background-color: var(--background);
            color: var(--text);
            min-height: 100vh;
            display: flex;
            flex-direction: column;
        }

        .arabic {
            font-family: 'Traditional Arabic', 'Arial', sans-serif;
            font-size: 1.5rem;
            text-align: right;
            direction: rtl;
            line-height: 2.5rem;
        }

        .urdu {
            font-family: 'Nastaliq', 'Urdu Typesetting', sans-serif;
            font-size: 1.2rem;
            text-align: right;
            direction: rtl;
        }

        .container {
            width: 100%;
            max-width: 1200px;
            margin: 0 auto;
            padding: 1rem;
            flex: 1;
        }

        header {
            background-color: var(--primary);
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
        }

        .logo {
            font-size: 1.5rem;
            font-weight: bold;
            color: var(--text);
        }

        .nav-toggle {
            background: none;
            border: none;
            color: var(--text);
            font-size: 1.5rem;
            cursor: pointer;
        }

        nav {
            position: fixed;
            top: 0;
            left: -300px;
            width: 300px;
            height: 100vh;
            background-color: var(--secondary);
            z-index: 1000;
            transition: left 0.3s;
            overflow-y: auto;
        }

        nav.open {
            left: 0;
        }

        .nav-header {
            padding: 1rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            background-color: var(--primary);
        }

        .close-nav {
            background: none;
            border: none;
            color: var(--text);
            font-size: 1.5rem;
            cursor: pointer;
        }

        .nav-list {
            list-style: none;
        }

        .nav-item {
            padding: 1rem;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
            cursor: pointer;
        }

        .nav-item:hover {
            background-color: rgba(255, 255, 255, 0.1);
        }

        .main-content {
            margin-top: 1rem;
        }

        .card {
            background-color: var(--card);
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
        }

        .surah-list {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
            gap: 1rem;
        }

        .surah-card {
            background-color: var(--secondary);
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: transform 0.2s;
        }

        .surah-card:hover {
            transform: translateY(-5px);
        }

        .ayah-card {
            margin-bottom: 1.5rem;
            position: relative;
        }

        .ayah-number {
            display: inline-block;
            width: 30px;
            height: 30px;
            background-color: var(--accent);
            color: white;
            border-radius: 50%;
            text-align: center;
            line-height: 30px;
            margin-left: 0.5rem;
        }

        .ayah-actions {
            display: flex;
            gap: 0.5rem;
            margin-top: 0.5rem;
        }

        .btn {
            padding: 0.5rem 1rem;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-weight: bold;
        }

        .btn-primary {
            background-color: var(--accent);
            color: white;
        }

        .btn-secondary {
            background-color: var(--secondary);
            color: var(--text);
        }

        .btn-success {
            background-color: var(--success);
            color: white;
        }

        .btn-warning {
            background-color: var(--warning);
            color: white;
        }

        .btn-danger {
            background-color: var(--danger);
            color: white;
        }

        .search-container {
            margin-bottom: 1rem;
        }

        .search-input {
            width: 100%;
            padding: 0.8rem;
            border-radius: 4px;
            border: 1px solid var(--secondary);
            background-color: var(--card);
            color: var(--text);
            font-size: 1rem;
        }

        .search-results .ayah-card {
            background-color: var(--secondary);
            padding: 1rem;
            border-radius: 8px;
            margin-bottom: 1rem;
        }

        .highlight {
            background-color: yellow;
            color: black;
        }

        .pagination {
            display: flex;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .page-btn {
            padding: 0.5rem 1rem;
            background-color: var(--secondary);
            color: var(--text);
            border: none;
            border-radius: 4px;
            cursor: pointer;
        }

        .page-btn.active {
            background-color: var(--accent);
            color: white;
        }

        .loading {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            flex-direction: column;
            gap: 1rem;
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid rgba(255, 255, 255, 0.3);
            border-radius: 50%;
            border-top-color: var(--accent);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .progress-bar {
            width: 100%;
            max-width: 300px;
            height: 10px;
            background-color: var(--secondary);
            border-radius: 5px;
            overflow: hidden;
        }

        .progress {
            height: 100%;
            background-color: var(--accent);
            width: 0%;
            transition: width 0.3s;
        }

        .settings-panel {
            display: none;
            padding: 1rem;
            background-color: var(--card);
            border-radius: 8px;
            margin-top: 1rem;
        }

        .settings-panel.open {
            display: block;
        }

        .setting-item {
            margin-bottom: 1rem;
        }

        .setting-label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: bold;
        }

        .select {
            width: 100%;
            padding: 0.5rem;
            background-color: var(--secondary);
            color: var(--text);
            border: 1px solid var(--primary);
            border-radius: 4px;
        }

        .checkbox {
            margin-right: 0.5rem;
        }

        .fullscreen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: var(--background);
            z-index: 2000;
            padding: 2rem;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        .fullscreen-content {
            max-width: 800px;
            width: 100%;
        }

        .close-fullscreen {
            position: fixed;
            top: 1rem;
            right: 1rem;
            background: none;
            border: none;
            color: var(--text);
            font-size: 1.5rem;
            cursor: pointer;
        }

        .bookmark-icon {
            color: var(--warning);
            cursor: pointer;
        }

        .note-textarea {
            width: 100%;
            padding: 0.5rem;
            background-color: var(--secondary);
            color: var(--text);
            border: 1px solid var(--primary);
            border-radius: 4px;
            margin-top: 0.5rem;
        }

        .tab-container {
            display: flex;
            border-bottom: 1px solid var(--secondary);
            margin-bottom: 1rem;
        }

        .tab {
            padding: 0.5rem 1rem;
            cursor: pointer;
            border-bottom: 2px solid transparent;
        }

        .tab.active {
            border-bottom: 2px solid var(--accent);
            font-weight: bold;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .stats-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 1rem;
        }

        .stat-card {
            background-color: var(--secondary);
            padding: 1rem;
            border-radius: 8px;
            text-align: center;
        }

        .stat-value {
            font-size: 2rem;
            font-weight: bold;
            color: var(--accent);
        }

        .stat-label {
            font-size: 0.9rem;
            color: var(--text-secondary);
        }

        .history-item {
            padding: 1rem;
            border-bottom: 1px solid var(--secondary);
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        @media (max-width: 768px) {
            .surah-list {
                grid-template-columns: repeat(auto-fill, minmax(120px, 1fr));
            }
        }

        @media (max-width: 480px) {
            .surah-list {
                grid-template-columns: repeat(auto-fill, minmax(100px, 1fr));
            }
        }
    </style>
</head>
<body>
    <header>
        <div class="logo">Quran App</div>
        <button class="nav-toggle" id="navToggle">☰</button>
    </header>

    <nav id="navMenu">
        <div class="nav-header">
            <div>Menu</div>
            <button class="close-nav" id="closeNav">×</button>
        </div>
        <ul class="nav-list">
            <li class="nav-item" data-section="surah-list">Surahs</li>
            <li class="nav-item" data-section="search">Search</li>
            <li class="nav-item" data-section="bookmarks">Bookmarks</li>
            <li class="nav-item" data-section="stats">Statistics</li>
            <li class="nav-item" data-section="history">History</li>
            <li class="nav-item" data-section="settings">Settings</li>
            <li class="nav-item" id="backupBtn">Backup Data</li>
            <li class="nav-item" id="restoreBtn">Restore Data</li>
        </ul>
    </nav>

    <div class="container">
        <div class="main-content">
            <div id="surah-list" class="tab-content active">
                <h2>Surahs</h2>
                <div class="surah-list" id="surahListContainer"></div>
            </div>

            <div id="surah-detail" class="tab-content">
                <div class="card">
                    <h2 id="surahName"></h2>
                    <div id="surahContent"></div>
                    <div class="pagination" id="surahPagination"></div>
                </div>
            </div>

            <div id="search" class="tab-content">
                <div class="search-container">
                    <input type="text" class="search-input" id="searchInput" placeholder="Search Quran...">
                </div>
                <div class="search-results" id="searchResults"></div>
            </div>

            <div id="bookmarks" class="tab-content">
                <h2>Bookmarks</h2>
                <div id="bookmarksList"></div>
            </div>

            <div id="stats" class="tab-content">
                <h2>Reading Statistics</h2>
                <div class="stats-container">
                    <div class="stat-card">
                        <div class="stat-value" id="totalRead">0</div>
                        <div class="stat-label">Ayahs Read</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="totalBookmarked">0</div>
                        <div class="stat-label">Bookmarks</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value" id="streak">0</div>
                        <div class="stat-label">Day Streak</div>
                    </div>
                </div>
                <h3 style="margin-top: 1rem;">Progress by Surah</h3>
                <div id="surahProgressChart"></div>
            </div>

            <div id="history" class="tab-content">
                <h2>Reading History</h2>
                <div id="historyList"></div>
            </div>

            <div id="settings" class="tab-content">
                <h2>Settings</h2>
                <div class="settings-panel open">
                    <div class="setting-item">
                        <label class="setting-label">Theme</label>
                        <select class="select" id="themeSelect">
                            <option value="dark">Dark</option>
                            <option value="light">Light</option>
                        </select>
                    </div>
                    <div class="setting-item">
                        <label class="setting-label">Arabic Font Size</label>
                        <select class="select" id="arabicFontSize">
                            <option value="1.5">Default</option>
                            <option value="1.2">Small</option>
                            <option value="1.8">Large</option>
                            <option value="2.2">Extra Large</option>
                        </select>
                    </div>
                    <div class="setting-item">
                        <label class="setting-label">Translation Font Size</label>
                        <select class="select" id="translationFontSize">
                            <option value="1.2">Default</option>
                            <option value="1.0">Small</option>
                            <option value="1.5">Large</option>
                            <option value="1.8">Extra Large</option>
                        </select>
                    </div>
                    <div class="setting-item">
                        <label class="setting-label">Show Arabic</label>
                        <input type="checkbox" class="checkbox" id="showArabic" checked>
                    </div>
                    <div class="setting-item">
                        <label class="setting-label">Show Translation</label>
                        <input type="checkbox" class="checkbox" id="showTranslation" checked>
                    </div>
                    <div class="setting-item">
                        <label class="setting-label">Daily Reminder</label>
                        <input type="checkbox" class="checkbox" id="dailyReminder">
                    </div>
                    <div class="setting-item" id="reminderTimeContainer" style="display: none;">
                        <label class="setting-label">Reminder Time</label>
                        <input type="time" class="select" id="reminderTime">
                    </div>
                    <button class="btn btn-primary" id="saveSettings">Save Settings</button>
                </div>
            </div>
        </div>
    </div>

    <div class="loading" id="loadingScreen">
        <div class="spinner"></div>
        <div>Loading Quran Data...</div>
        <div class="progress-bar">
            <div class="progress" id="loadingProgress"></div>
        </div>
    </div>

    <input type="file" id="restoreFileInput" style="display: none;">

    <script>
        document.addEventListener('DOMContentLoaded', async function() {
            // DOM Elements
            const navToggle = document.getElementById('navToggle');
            const navMenu = document.getElementById('navMenu');
            const closeNav = document.getElementById('closeNav');
            const navItems = document.querySelectorAll('.nav-item');
            const tabContents = document.querySelectorAll('.tab-content');
            const loadingScreen = document.getElementById('loadingScreen');
            const loadingProgress = document.getElementById('loadingProgress');
            const surahListContainer = document.getElementById('surahListContainer');
            const surahName = document.getElementById('surahName');
            const surahContent = document.getElementById('surahContent');
            const surahPagination = document.getElementById('surahPagination');
            const searchInput = document.getElementById('searchInput');
            const searchResults = document.getElementById('searchResults');
            const bookmarksList = document.getElementById('bookmarksList');
            const totalRead = document.getElementById('totalRead');
            const totalBookmarked = document.getElementById('totalBookmarked');
            const streak = document.getElementById('streak');
            const historyList = document.getElementById('historyList');
            const themeSelect = document.getElementById('themeSelect');
            const arabicFontSize = document.getElementById('arabicFontSize');
            const translationFontSize = document.getElementById('translationFontSize');
            const showArabic = document.getElementById('showArabic');
            const showTranslation = document.getElementById('showTranslation');
            const dailyReminder = document.getElementById('dailyReminder');
            const reminderTime = document.getElementById('reminderTime');
            const reminderTimeContainer = document.getElementById('reminderTimeContainer');
            const saveSettings = document.getElementById('saveSettings');
            const backupBtn = document.getElementById('backupBtn');
            const restoreBtn = document.getElementById('restoreBtn');
            const restoreFileInput = document.getElementById('restoreFileInput');

            // Database variables
            let db;
            const DB_NAME = 'quranDB';
            const DB_VERSION = 1;
            const AYAH_STORE = 'ayahs';
            const BOOKMARK_STORE = 'bookmarks';
            const SETTINGS_STORE = 'settings';
            const HISTORY_STORE = 'history';

            // App state
            let currentSurah = null;
            let currentPage = 1;
            const ayahsPerPage = 10;
            let surahNames = Array(114).fill().map((_, i) => `Surah ${i+1}`);

            // Initialize the app
            initApp();

            // Event Listeners
            navToggle.addEventListener('click', () => navMenu.classList.add('open'));
            closeNav.addEventListener('click', () => navMenu.classList.remove('open'));

            navItems.forEach(item => {
                if (item.dataset.section) {
                    item.addEventListener('click', () => {
                        showSection(item.dataset.section);
                        navMenu.classList.remove('open');
                    });
                }
            });

            dailyReminder.addEventListener('change', function() {
                reminderTimeContainer.style.display = this.checked ? 'block' : 'none';
            });

            saveSettings.addEventListener('click', saveAppSettings);
            backupBtn.addEventListener('click', backupData);
            restoreBtn.addEventListener('click', () => restoreFileInput.click());
            restoreFileInput.addEventListener('change', restoreData);

            // Functions
            async function initApp() {
                try {
                    db = await openDatabase();
                    const isInitialized = await checkInitialization();

                    if (!isInitialized) {
                        await fetchAndStoreQuranData();
                    } else {
                        loadingScreen.style.display = 'none';
                    }

                    await loadAppSettings();
                    renderSurahList();
                    loadStats();
                    loadHistory();
                    setupReminders();
                } catch (error) {
                    console.error('Initialization error:', error);
                    loadingScreen.innerHTML = '<div>Error loading application. Please refresh the page.</div>';
                }
            }

            function openDatabase() {
                return new Promise((resolve, reject) => {
                    const request = indexedDB.open(DB_NAME, DB_VERSION);

                    request.onupgradeneeded = function(event) {
                        const db = event.target.result;

                        if (!db.objectStoreNames.contains(AYAH_STORE)) {
                            const store = db.createObjectStore(AYAH_STORE, { keyPath: 'id' });
                            store.createIndex('surah', 'surah', { unique: false });
                            store.createIndex('ayah', 'ayah', { unique: false });
                        }

                        if (!db.objectStoreNames.contains(BOOKMARK_STORE)) {
                            const store = db.createObjectStore(BOOKMARK_STORE, { keyPath: 'id' });
                            store.createIndex('surah', 'surah', { unique: false });
                            store.createIndex('ayah', 'ayah', { unique: false });
                        }

                        if (!db.objectStoreNames.contains(SETTINGS_STORE)) {
                            db.createObjectStore(SETTINGS_STORE, { keyPath: 'key' });
                        }

                        if (!db.objectStoreNames.contains(HISTORY_STORE)) {
                            db.createObjectStore(HISTORY_STORE, { keyPath: 'id', autoIncrement: true });
                        }
                    };

                    request.onsuccess = function(event) {
                        resolve(event.target.result);
                    };

                    request.onerror = function(event) {
                        reject(event.target.error);
                    };
                });
            }

            async function checkInitialization() {
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction(SETTINGS_STORE, 'readonly');
                    const store = transaction.objectStore(SETTINGS_STORE);
                    const request = store.get('initialized');

                    request.onsuccess = function() {
                        resolve(!!request.result);
                    };

                    request.onerror = function() {
                        reject(request.error);
                    };
                });
            }

            async function fetchAndStoreQuranData() {
                try {
                    const response = await fetch('data/data.AM');
                    if (!response.ok) throw new Error('Failed to fetch Quran data');
                    
                    const text = await response.text();
                    const lines = text.split('\n').filter(line => line.trim());
                    const totalLines = lines.length;
                    let processed = 0;

                    const transaction = db.transaction([AYAH_STORE, SETTINGS_STORE], 'readwrite');
                    const ayahStore = transaction.objectStore(AYAH_STORE);
                    const settingsStore = transaction.objectStore(SETTINGS_STORE);

                    for (const line of lines) {
                        try {
                            const ayah = parseAyahLine(line);
                            if (ayah) {
                                ayahStore.put(ayah);
                            }
                        } catch (error) {
                            console.error('Error parsing ayah:', line, error);
                        }

                        processed++;
                        const progress = Math.floor((processed / totalLines) * 100);
                        loadingProgress.style.width = `${progress}%`;
                    }

                    settingsStore.put({ key: 'initialized', value: true });

                    await new Promise((resolve, reject) => {
                        transaction.oncomplete = resolve;
                        transaction.onerror = () => reject(transaction.error);
                    });

                    loadingScreen.style.display = 'none';
                } catch (error) {
                    console.error('Error fetching and storing Quran data:', error);
                    throw error;
                }
            }

            function parseAyahLine(line) {
                const parts = line.split(' ترجمہ: ');
                if (parts.length !== 2) return null;

                const arabic = parts[0].trim();
                const remaining = parts[1].split('س ');
                if (remaining.length !== 2) return null;

                const urdu = remaining[0].trim();
                const surahAyah = remaining[1].split(' آ ');
                if (surahAyah.length !== 2) return null;

                const surah = parseInt(surahAyah[0].trim());
                const ayah = parseInt(surahAyah[1].trim());

                return {
                    id: `${surah}:${ayah}`,
                    surah,
                    ayah,
                    arabic,
                    urdu
                };
            }

            function showSection(sectionId) {
                tabContents.forEach(content => content.classList.remove('active'));
                document.getElementById(sectionId).classList.add('active');

                if (sectionId === 'surah-list') {
                    renderSurahList();
                } else if (sectionId === 'bookmarks') {
                    loadBookmarks();
                } else if (sectionId === 'stats') {
                    loadStats();
                } else if (sectionId === 'history') {
                    loadHistory();
                }
            }

            function renderSurahList() {
                surahListContainer.innerHTML = '';
                for (let i = 1; i <= 114; i++) {
                    const surahCard = document.createElement('div');
                    surahCard.className = 'surah-card';
                    surahCard.innerHTML = `
                        <div>${i}</div>
                        <div>${surahNames[i-1]}</div>
                    `;
                    surahCard.addEventListener('click', () => showSurahDetail(i));
                    surahListContainer.appendChild(surahCard);
                }
            }

            async function showSurahDetail(surahNumber) {
                currentSurah = surahNumber;
                currentPage = 1;
                
                tabContents.forEach(content => content.classList.remove('active'));
                document.getElementById('surah-detail').classList.add('active');
                
                surahName.textContent = surahNames[surahNumber-1];
                await renderSurahContent(surahNumber, currentPage);
                renderPagination(surahNumber);
            }

            async function renderSurahContent(surahNumber, page) {
                surahContent.innerHTML = '';
                
                const startAyah = (page - 1) * ayahsPerPage + 1;
                const endAyah = page * ayahsPerPage;
                
                const ayahs = await getAyahsInRange(surahNumber, startAyah, endAyah);
                
                ayahs.forEach(ayah => {
                    const ayahCard = document.createElement('div');
                    ayahCard.className = 'ayah-card';
                    ayahCard.dataset.surah = ayah.surah;
                    ayahCard.dataset.ayah = ayah.ayah;
                    
                    const isBookmarked = checkBookmark(ayah.surah, ayah.ayah);
                    const bookmarkIcon = isBookmarked ? '★' : '☆';
                    
                    ayahCard.innerHTML = `
                        <div class="arabic" style="font-size: ${arabicFontSize.value}rem">
                            ${ayah.arabic} <span class="ayah-number">${ayah.ayah}</span>
                        </div>
                        <div class="urdu" style="font-size: ${translationFontSize.value}rem">
                            ${ayah.urdu}
                        </div>
                        <div class="ayah-actions">
                            <button class="btn btn-primary" onclick="toggleFullscreen(${ayah.surah}, ${ayah.ayah})">Fullscreen</button>
                            <span class="bookmark-icon" onclick="toggleBookmark(${ayah.surah}, ${ayah.ayah})">${bookmarkIcon}</span>
                        </div>
                        <textarea class="note-textarea" placeholder="Add notes..." data-surah="${ayah.surah}" data-ayah="${ayah.ayah}"></textarea>
                    `;
                    
                    surahContent.appendChild(ayahCard);
                    logHistory(surahNumber, ayah.ayah);
                });
            }

            async function getAyahsInRange(surahNumber, startAyah, endAyah) {
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction(AYAH_STORE, 'readonly');
                    const store = transaction.objectStore(AYAH_STORE);
                    const index = store.index('surah');
                    const range = IDBKeyRange.only(surahNumber);
                    const request = index.openCursor(range);
                    const ayahs = [];

                    request.onsuccess = function(event) {
                        const cursor = event.target.result;
                        if (cursor) {
                            if (cursor.value.ayah >= startAyah && cursor.value.ayah <= endAyah) {
                                ayahs.push(cursor.value);
                            }
                            if (cursor.value.ayah < endAyah) {
                                cursor.continue();
                            } else {
                                ayahs.sort((a, b) => a.ayah - b.ayah);
                                resolve(ayahs);
                            }
                        } else {
                            ayahs.sort((a, b) => a.ayah - b.ayah);
                            resolve(ayahs);
                        }
                    };

                    request.onerror = function(event) {
                        reject(event.target.error);
                    };
                });
            }

            function renderPagination(surahNumber) {
                surahPagination.innerHTML = '';
                
                getAyahCount(surahNumber).then(count => {
                    const pageCount = Math.ceil(count / ayahsPerPage);
                    
                    for (let i = 1; i <= pageCount; i++) {
                        const pageBtn = document.createElement('button');
                        pageBtn.className = `page-btn ${i === currentPage ? 'active' : ''}`;
                        pageBtn.textContent = i;
                        pageBtn.addEventListener('click', () => {
                            currentPage = i;
                            renderSurahContent(surahNumber, currentPage);
                            renderPagination(surahNumber);
                        });
                        surahPagination.appendChild(pageBtn);
                    }
                });
            }

            async function getAyahCount(surahNumber) {
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction(AYAH_STORE, 'readonly');
                    const store = transaction.objectStore(AYAH_STORE);
                    const index = store.index('surah');
                    const range = IDBKeyRange.only(surahNumber);
                    const request = index.count(range);

                    request.onsuccess = function() {
                        resolve(request.result);
                    };

                    request.onerror = function() {
                        reject(request.error);
                    };
                });
            }

            function toggleFullscreen(surah, ayah) {
                const fullscreenDiv = document.createElement('div');
                fullscreenDiv.className = 'fullscreen';
                fullscreenDiv.innerHTML = `
                    <button class="close-fullscreen" onclick="document.body.removeChild(this.parentNode)">×</button>
                    <div class="fullscreen-content" id="fullscreenContent"></div>
                `;
                
                document.body.appendChild(fullscreenDiv);
                
                getAyah(surah, ayah).then(ayah => {
                    const content = document.getElementById('fullscreenContent');
                    content.innerHTML = `
                        <div class="arabic" style="font-size: ${parseInt(arabicFontSize.value) + 0.5}rem; text-align: center; margin-bottom: 2rem">
                            ${ayah.arabic}
                        </div>
                        <div class="urdu" style="font-size: ${parseInt(translationFontSize.value) + 0.3}rem; text-align: center">
                            ${ayah.urdu}
                        </div>
                    `;
                });
            }

            async function getAyah(surah, ayah) {
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction(AYAH_STORE, 'readonly');
                    const store = transaction.objectStore(AYAH_STORE);
                    const request = store.get(`${surah}:${ayah}`);

                    request.onsuccess = function() {
                        resolve(request.result);
                    };

                    request.onerror = function() {
                        reject(request.error);
                    };
                });
            }

            function toggleBookmark(surah, ayah) {
                const id = `${surah}:${ayah}`;
                
                checkBookmark(surah, ayah).then(isBookmarked => {
                    const transaction = db.transaction(BOOKMARK_STORE, 'readwrite');
                    const store = transaction.objectStore(BOOKMARK_STORE);
                    
                    if (isBookmarked) {
                        store.delete(id);
                    } else {
                        store.put({ id, surah, ayah, date: new Date().toISOString() });
                    }
                    
                    transaction.oncomplete = function() {
                        if (document.getElementById('bookmarks').classList.contains('active')) {
                            loadBookmarks();
                        }
                        if (currentSurah === surah) {
                            renderSurahContent(surah, currentPage);
                        }
                        loadStats();
                    };
                });
            }

            function checkBookmark(surah, ayah) {
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction(BOOKMARK_STORE, 'readonly');
                    const store = transaction.objectStore(BOOKMARK_STORE);
                    const request = store.get(`${surah}:${ayah}`);

                    request.onsuccess = function() {
                        resolve(!!request.result);
                    };

                    request.onerror = function() {
                        reject(request.error);
                    };
                });
            }

            async function loadBookmarks() {
                const bookmarks = await getAllBookmarks();
                bookmarksList.innerHTML = '';
                
                if (bookmarks.length === 0) {
                    bookmarksList.innerHTML = '<div class="card">No bookmarks yet.</div>';
                    return;
                }
                
                bookmarks.forEach(bookmark => {
                    getAyah(bookmark.surah, bookmark.ayah).then(ayah => {
                        const bookmarkCard = document.createElement('div');
                        bookmarkCard.className = 'ayah-card card';
                        bookmarkCard.innerHTML = `
                            <div class="arabic" style="font-size: ${arabicFontSize.value}rem">
                                ${ayah.arabic} <span class="ayah-number">${ayah.ayah}</span>
                            </div>
                            <div class="urdu" style="font-size: ${translationFontSize.value}rem">
                                ${ayah.urdu}
                            </div>
                            <div class="ayah-actions">
                                <button class="btn btn-primary" onclick="showSurahDetail(${ayah.surah})">Go to Surah</button>
                                <span class="bookmark-icon" onclick="toggleBookmark(${ayah.surah}, ${ayah.ayah})">★</span>
                            </div>
                            <div style="font-size: 0.8rem; color: var(--text-secondary); margin-top: 0.5rem">
                                Bookmarked on ${new Date(bookmark.date).toLocaleDateString()}
                            </div>
                        `;
                        bookmarksList.appendChild(bookmarkCard);
                    });
                });
            }

            function getAllBookmarks() {
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction(BOOKMARK_STORE, 'readonly');
                    const store = transaction.objectStore(BOOKMARK_STORE);
                    const request = store.getAll();

                    request.onsuccess = function() {
                        resolve(request.result);
                    };

                    request.onerror = function() {
                        reject(request.error);
                    };
                });
            }

            async function loadStats() {
                const [totalReadCount, totalBookmarkedCount, streakCount] = await Promise.all([
                    getTotalReadCount(),
                    getTotalBookmarkedCount(),
                    getStreakCount()
                ]);
                
                totalRead.textContent = totalReadCount;
                totalBookmarked.textContent = totalBookmarkedCount;
                streak.textContent = streakCount;
            }

            function getTotalReadCount() {
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction(HISTORY_STORE, 'readonly');
                    const store = transaction.objectStore(HISTORY_STORE);
                    const request = store.getAll();

                    request.onsuccess = function() {
                        const uniqueAyahs = new Set();
                        request.result.forEach(entry => {
                            uniqueAyahs.add(`${entry.surah}:${entry.ayah}`);
                        });
                        resolve(uniqueAyahs.size);
                    };

                    request.onerror = function() {
                        reject(request.error);
                    };
                });
            }

            function getTotalBookmarkedCount() {
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction(BOOKMARK_STORE, 'readonly');
                    const store = transaction.objectStore(BOOKMARK_STORE);
                    const request = store.count();

                    request.onsuccess = function() {
                        resolve(request.result);
                    };

                    request.onerror = function() {
                        reject(request.error);
                    };
                });
            }

            function getStreakCount() {
                return new Promise((resolve) => {
                    // Simplified streak calculation
                    // In a real app, you'd track daily reading and calculate properly
                    resolve(0);
                });
            }

            async function loadHistory() {
                const history = await getRecentHistory();
                historyList.innerHTML = '';
                
                if (history.length === 0) {
                    historyList.innerHTML = '<div class="card">No history yet.</div>';
                    return;
                }
                
                history.forEach(entry => {
                    const historyItem = document.createElement('div');
                    historyItem.className = 'history-item card';
                    historyItem.innerHTML = `
                        <div>
                            <strong>Surah ${entry.surah}:${entry.ayah}</strong>
                            <div style="font-size: 0.8rem; color: var(--text-secondary)">
                                ${new Date(entry.timestamp).toLocaleString()}
                            </div>
                        </div>
                        <button class="btn btn-primary" onclick="showSurahDetail(${entry.surah})">View</button>
                    `;
                    historyList.appendChild(historyItem);
                });
            }

            function getRecentHistory(limit = 20) {
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction(HISTORY_STORE, 'readonly');
                    const store = transaction.objectStore(HISTORY_STORE);
                    const request = store.getAll();

                    request.onsuccess = function() {
                        const history = request.result
                            .sort((a, b) => new Date(b.timestamp) - new Date(a.timestamp))
                            .slice(0, limit);
                        resolve(history);
                    };

                    request.onerror = function() {
                        reject(request.error);
                    };
                });
            }

            function logHistory(surah, ayah) {
                const transaction = db.transaction(HISTORY_STORE, 'readwrite');
                const store = transaction.objectStore(HISTORY_STORE);
                
                store.put({
                    surah,
                    ayah,
                    timestamp: new Date().toISOString()
                });
            }

            async function loadAppSettings() {
                const settings = await getAllSettings();
                
                if (settings.theme) {
                    themeSelect.value = settings.theme;
                    document.documentElement.setAttribute('data-theme', settings.theme);
                }
                
                if (settings.arabicFontSize) {
                    arabicFontSize.value = settings.arabicFontSize;
                }
                
                if (settings.translationFontSize) {
                    translationFontSize.value = settings.translationFontSize;
                }
                
                if (settings.showArabic) {
                    showArabic.checked = settings.showArabic === 'true';
                }
                
                if (settings.showTranslation) {
                    showTranslation.checked = settings.showTranslation === 'true';
                }
                
                if (settings.dailyReminder) {
                    dailyReminder.checked = settings.dailyReminder === 'true';
                    reminderTimeContainer.style.display = dailyReminder.checked ? 'block' : 'none';
                }
                
                if (settings.reminderTime) {
                    reminderTime.value = settings.reminderTime;
                }
            }

            function getAllSettings() {
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction(SETTINGS_STORE, 'readonly');
                    const store = transaction.objectStore(SETTINGS_STORE);
                    const request = store.getAll();

                    request.onsuccess = function() {
                        const settings = {};
                        request.result.forEach(setting => {
                            settings[setting.key] = setting.value;
                        });
                        resolve(settings);
                    };

                    request.onerror = function() {
                        reject(request.error);
                    };
                });
            }

            function saveAppSettings() {
                const transaction = db.transaction(SETTINGS_STORE, 'readwrite');
                const store = transaction.objectStore(SETTINGS_STORE);
                
                const settings = {
                    theme: themeSelect.value,
                    arabicFontSize: arabicFontSize.value,
                    translationFontSize: translationFontSize.value,
                    showArabic: showArabic.checked.toString(),
                    showTranslation: showTranslation.checked.toString(),
                    dailyReminder: dailyReminder.checked.toString(),
                    reminderTime: reminderTime.value
                };
                
                Object.entries(settings).forEach(([key, value]) => {
                    store.put({ key, value });
                });
                
                document.documentElement.setAttribute('data-theme', themeSelect.value);
                
                transaction.oncomplete = function() {
                    alert('Settings saved successfully');
                };
            }

            function setupReminders() {
                if ('Notification' in window) {
                    Notification.requestPermission().then(permission => {
                        if (permission === 'granted') {
                            // Check if we need to schedule a reminder
                            checkAndScheduleReminder();
                        }
                    });
                }
            }

            async function checkAndScheduleReminder() {
                const settings = await getAllSettings();
                if (settings.dailyReminder === 'true' && settings.reminderTime) {
                    scheduleDailyReminder(settings.reminderTime);
                }
            }

            function scheduleDailyReminder(time) {
                // This is a simplified version. In a real app, you'd use the Notification API
                // and possibly the Background Sync API for more reliable reminders
                console.log(`Daily reminder scheduled for ${time}`);
            }

            function backupData() {
                Promise.all([
                    getAllBookmarks(),
                    getAllSettings(),
                    getRecentHistory(1000) // Get all history for backup
                ]).then(([bookmarks, settings, history]) => {
                    const backup = {
                        bookmarks,
                        settings,
                        history,
                        timestamp: new Date().toISOString()
                    };
                    
                    const blob = new Blob([JSON.stringify(backup)], { type: 'application/json' });
                    const url = URL.createObjectURL(blob);
                    
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `quran-app-backup-${new Date().toISOString().split('T')[0]}.json`;
                    a.click();
                    
                    URL.revokeObjectURL(url);
                });
            }

            function restoreData(event) {
                const file = event.target.files[0];
                if (!file) return;
                
                const reader = new FileReader();
                reader.onload = function(e) {
                    try {
                        const backup = JSON.parse(e.target.result);
                        restoreBackupData(backup);
                    } catch (error) {
                        alert('Error parsing backup file');
                        console.error(error);
                    }
                };
                reader.readAsText(file);
            }

            function restoreBackupData(backup) {
                if (!confirm('Restoring backup will overwrite your current data. Continue?')) return;
                
                const transaction = db.transaction(
                    [BOOKMARK_STORE, SETTINGS_STORE, HISTORY_STORE], 
                    'readwrite'
                );
                
                const bookmarkStore = transaction.objectStore(BOOKMARK_STORE);
                const settingsStore = transaction.objectStore(SETTINGS_STORE);
                const historyStore = transaction.objectStore(HISTORY_STORE);
                
                // Clear existing data
                bookmarkStore.clear();
                settingsStore.clear();
                historyStore.clear();
                
                // Restore bookmarks
                if (backup.bookmarks) {
                    backup.bookmarks.forEach(bookmark => {
                        bookmarkStore.put(bookmark);
                    });
                }
                
                // Restore settings
                if (backup.settings) {
                    Object.entries(backup.settings).forEach(([key, value]) => {
                        settingsStore.put({ key, value });
                    });
                }
                
                // Restore history
                if (backup.history) {
                    backup.history.forEach(entry => {
                        historyStore.put(entry);
                    });
                }
                
                transaction.oncomplete = function() {
                    alert('Backup restored successfully');
                    location.reload();
                };
                
                transaction.onerror = function() {
                    alert('Error restoring backup');
                };
            }

            // Search functionality
            searchInput.addEventListener('input', debounce(performSearch, 300));

            function debounce(func, wait) {
                let timeout;
                return function() {
                    const context = this, args = arguments;
                    clearTimeout(timeout);
                    timeout = setTimeout(() => func.apply(context, args), wait);
                };
            }

            async function performSearch() {
                const query = searchInput.value.trim();
                if (query.length < 2) {
                    searchResults.innerHTML = '';
                    return;
                }
                
                const results = await searchAyahs(query);
                displaySearchResults(results, query);
            }

            function searchAyahs(query) {
                return new Promise((resolve, reject) => {
                    const transaction = db.transaction(AYAH_STORE, 'readonly');
                    const store = transaction.objectStore(AYAH_STORE);
                    const request = store.getAll();
                    
                    request.onsuccess = function() {
                        const normalizedQuery = normalizeText(query);
                        const results = request.result.filter(ayah => {
                            const arabic = normalizeText(ayah.arabic);
                            const urdu = normalizeText(ayah.urdu);
                            return arabic.includes(normalizedQuery) || urdu.includes(normalizedQuery);
                        });
                        resolve(results);
                    };
                    
                    request.onerror = function() {
                        reject(request.error);
                    };
                });
            }

            function normalizeText(text) {
                return text
                    .normalize('NFKD') // Normalize to decomposed form
                    .replace(/[\u064B-\u065F\u0670]/g, '') // Remove Arabic diacritics
                    .toLowerCase();
            }

            function displaySearchResults(results, query) {
                searchResults.innerHTML = '';
                
                if (results.length === 0) {
                    searchResults.innerHTML = '<div class="card">No results found</div>';
                    return;
                }
                
                const normalizedQuery = normalizeText(query);
                
                results.forEach(ayah => {
                    const resultCard = document.createElement('div');
                    resultCard.className = 'ayah-card card';
                    
                    const highlightedArabic = highlightText(ayah.arabic, normalizedQuery);
                    const highlightedUrdu = highlightText(ayah.urdu, normalizedQuery);
                    
                    resultCard.innerHTML = `
                        <div class="arabic" style="font-size: ${arabicFontSize.value}rem">
                            ${highlightedArabic} <span class="ayah-number">${ayah.ayah}</span>
                        </div>
                        <div class="urdu" style="font-size: ${translationFontSize.value}rem">
                            ${highlightedUrdu}
                        </div>
                        <div class="ayah-actions">
                            <button class="btn btn-primary" onclick="showSurahDetail(${ayah.surah})">Go to Surah</button>
                        </div>
                    `;
                    
                    searchResults.appendChild(resultCard);
                });
            }

            function highlightText(text, query) {
                const normalizedText = normalizeText(text);
                const normalizedQuery = normalizeText(query);
                
                if (!normalizedText.includes(normalizedQuery)) {
                    return text;
                }
                
                const startIndex = normalizedText.indexOf(normalizedQuery);
                const endIndex = startIndex + query.length;
                
                return text.substring(0, startIndex) + 
                       `<span class="highlight">${text.substring(startIndex, endIndex)}</span>` + 
                       text.substring(endIndex);
            }

            // Make functions available globally for inline event handlers
            window.toggleFullscreen = toggleFullscreen;
            window.toggleBookmark = toggleBookmark;
            window.showSurahDetail = showSurahDetail;
        });
    </script>
</body>
</html>